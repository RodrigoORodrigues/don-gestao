<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Gestão - Don Gestão (Cloud)</title>
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: { extend: { colors: { slate: { 750: '#2d3748' } } } }
        }
    </script>

    <!-- Bibliotecas Essenciais -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Supabase SDK e Outras Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; } 
        .dark ::-webkit-scrollbar-track { background: #0f172a; } 
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 h-screen overflow-hidden selection:bg-blue-500 selection:text-white transition-colors duration-200">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        // Configuração do PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const { useState, useEffect, useRef } = React;
        
        // ============================================================================
        // 1. CONFIGURAÇÃO DO SUPABASE
        // ============================================================================
        
        const SUPABASE_URL = 'https://ivyujdcwvbjoaqpzvuyv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2eXVqZGN3dmJqb2FxcHp2dXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTgxMzcsImV4cCI6MjA4NzUzNDEzN30.UqptrsjHWG_PEu1KmWd0IxDvLnEX9AWwkKsuWJuA3T0';

        // Verificação mais robusta
        const isSupabaseConfigured = SUPABASE_URL && SUPABASE_URL.startsWith('http') && SUPABASE_KEY && SUPABASE_KEY.startsWith('eyJ');
        const supabase = isSupabaseConfigured ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

        // ============================================================================

        const SYSTEM_MODULES = [
            { id: 'dashboard', label: 'Visão Geral (Dashboard)' },
            { id: 'vendas', label: 'Vendas de Serviços' },
            { id: 'clientes', label: 'Gestão de Clientes' },
            { id: 'processar', label: 'Relatórios de Comissão (Processamento)' },
            { id: 'historico', label: 'Histórico de Relatórios Salvos' },
            { id: 'gestor', label: 'Gestor de Extratos (Arquivos Internos)' },
            { id: 'usuarios', label: 'Controle de Acessos e Permissões' },
            { id: 'settings', label: 'Configurações do Sistema e Backups' }
        ];

        // --- SISTEMA DE ÍCONES ---
        const toPascalCase = (str) => str.replace(/(^\w|-\w)/g, (clear) => clear.replace(/-/, "").toUpperCase());
        const IconWrapper = ({ icon, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[toPascalCase(icon)]) {
                    const svg = lucide.createElement(lucide.icons[toPascalCase(icon)]);
                    svg.setAttribute('width', size); svg.setAttribute('height', size);
                    svg.setAttribute('class', `lucide lucide-${icon} ${className}`);
                    ref.current.innerHTML = ''; ref.current.appendChild(svg);
                }
            }, [icon, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center' }} />;
        };

        const Icons = {
            Folder: (p) => <IconWrapper icon="folder" {...p} />,
            FileText: (p) => <IconWrapper icon="file-text" {...p} />,
            Plus: (p) => <IconWrapper icon="plus" {...p} />,
            Home: (p) => <IconWrapper icon="home" {...p} />,
            ChevronRight: (p) => <IconWrapper icon="chevron-right" {...p} />,
            ChevronDown: (p) => <IconWrapper icon="chevron-down" {...p} />,
            Save: (p) => <IconWrapper icon="save" {...p} />,
            ArrowLeft: (p) => <IconWrapper icon="arrow-left" {...p} />,
            Building2: (p) => <IconWrapper icon="building-2" {...p} />,
            FolderTree: (p) => <IconWrapper icon="folder-tree" {...p} />,
            FileSpreadsheet: (p) => <IconWrapper icon="file-spreadsheet" {...p} />,
            Download: (p) => <IconWrapper icon="download" {...p} />,
            X: (p) => <IconWrapper icon="x" {...p} />,
            Search: (p) => <IconWrapper icon="search" {...p} />,
            Eye: (p) => <IconWrapper icon="eye" {...p} />,
            EyeOff: (p) => <IconWrapper icon="eye-off" {...p} />,
            Layers: (p) => <IconWrapper icon="layers" {...p} />,
            Settings: (p) => <IconWrapper icon="settings" {...p} />,
            Database: (p) => <IconWrapper icon="database" {...p} />,
            RefreshCw: (p) => <IconWrapper icon="refresh-cw" {...p} />,
            Trash2: (p) => <IconWrapper icon="trash-2" {...p} />,
            HardDrive: (p) => <IconWrapper icon="hard-drive" {...p} />,
            Users: (p) => <IconWrapper icon="users" {...p} />,
            FileCheck: (p) => <IconWrapper icon="file-check-2" {...p} />,
            CheckCircle: (p) => <IconWrapper icon="check-circle-2" {...p} />,
            XCircle: (p) => <IconWrapper icon="x-circle" {...p} />,
            Edit: (p) => <IconWrapper icon="edit" {...p} />,
            ListFilter: (p) => <IconWrapper icon="list-filter" {...p} />,
            Upload: (p) => <IconWrapper icon="upload" {...p} />,
            Sun: (p) => <IconWrapper icon="sun" {...p} />,
            Moon: (p) => <IconWrapper icon="moon" {...p} />,
            Printer: (p) => <IconWrapper icon="printer" {...p} />,
            Archive: (p) => <IconWrapper icon="archive" {...p} />,
            History: (p) => <IconWrapper icon="history" {...p} />,
            AlertCircle: (p) => <IconWrapper icon="alert-circle" {...p} />,
            Lock: (p) => <IconWrapper icon="lock" {...p} />,
            User: (p) => <IconWrapper icon="user" {...p} />,
            Key: (p) => <IconWrapper icon="key" {...p} />,
            LogOut: (p) => <IconWrapper icon="log-out" {...p} />,
            Shield: (p) => <IconWrapper icon="shield" {...p} />,
            ShoppingCart: (p) => <IconWrapper icon="shopping-cart" {...p} />,
        };

        const EMPRESAS_INTERNAS = ["Proper", "Protetta"];
        const CATEGORIAS = ["Operadoras", "Seguradoras"];
        const MESES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const dataDeHojeInterna = () => new Date().toISOString().split('T')[0];
        const formatarMoeda = (valor) => valor ? valor.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
        const formatarDataVisivel = (dataString) => {
            if(!dataString) return '--/--/----';
            const partes = dataString.split('-');
            return partes.length === 3 ? `${partes[2]}/${partes[1]}/${partes[0]}` : dataString;
        };

        const SidebarItem = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${active ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white'}`}>
                <Icon size={20} /><span className="font-medium text-sm">{label}</span>
            </button>
        );

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-white p-6">
                            <Icons.AlertCircle size={64} className="text-rose-500 mb-4" />
                            <h1 className="text-3xl font-bold mb-2">Ops! Algo quebrou.</h1>
                            <p className="text-slate-400 mb-6 text-center max-w-md">Recarregue a página.</p>
                            <button onClick={() => window.location.reload()} className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-bold transition-colors">Recarregar Sistema</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        function GestorComissoesApp() {
            // Se o Supabase não estiver configurado
            if (!isSupabaseConfigured) {
                return (
                    <div className="flex h-screen w-screen items-center justify-center bg-slate-900 p-6">
                        <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full text-center border border-slate-700">
                            <Icons.Database size={48} className="text-blue-500 mx-auto mb-4" />
                            <h1 className="text-2xl font-bold text-white mb-2">Conexão Cloud Necessária</h1>
                            <p className="text-slate-400 mb-6 text-sm">As credenciais do Supabase precisam ser configuradas corretamente.</p>
                        </div>
                    </div>
                );
            }

            // TEMA
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('protetta_theme');
                return saved ? saved === 'dark' : true; 
            });

            // AUTENTICAÇÃO
            const [currentUser, setCurrentUser] = useState(() => {
                try {
                    const saved = localStorage.getItem('protetta_auth_user');
                    if (!saved || saved === 'undefined' || saved === 'null') return null;
                    const parsed = JSON.parse(saved);
                    if (parsed && typeof parsed === 'object' && parsed.username) return parsed;
                    return null;
                } catch(e) { return null; }
            });
            const [loginData, setLoginData] = useState({ user: '', password: '' });
            const [loginError, setLoginError] = useState('');
            const [showPassword, setShowPassword] = useState(false);

            // VERIFICAÇÃO DE ACESSO
            const hasAccess = (module) => {
                if (!currentUser || typeof currentUser !== 'object') return false;
                if (currentUser.username === 'admin' || currentUser.role === 'admin') return true; 
                return Array.isArray(currentUser.permissions) && currentUser.permissions.includes(module);
            };

            // SISTEMA DE ALERTAS
            const [alertDialog, setAlertDialog] = useState({ isOpen: false, message: '' });
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, message: '', onConfirm: null });

            const showAlert = (msg) => setAlertDialog({ isOpen: true, message: msg });
            const showConfirm = (msg, callback) => setConfirmDialog({ isOpen: true, message: msg, onConfirm: callback });

            const [currentView, setCurrentView] = useState('dashboard'); 
            const [loading, setLoading] = useState(false);
            const [loadingMsg, setLoadingMsg] = useState('');

            // ESTADOS 
            const [dbReports, setDbReports] = useState([]);
            const [currentPath, setCurrentPath] = useState([]); 
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedFile, setSelectedFile] = useState(null);

            const [clientes, setClientes] = useState([]);
            const [filtroNomeCliente, setFiltroNomeCliente] = useState('');
            const [showColMenu, setShowColMenu] = useState(false);
            const [cols, setCols] = useState({ codigo: false, nome: true, tipo: true, documento: true, telefone: true, celular: true, email: true, situacao: true, cadastrado_em: true, acoes: true });

            const [modalClienteOpen, setModalClienteOpen] = useState(false);
            const [modalBuscaOpen, setModalBuscaOpen] = useState(false);
            const [clienteEditIndex, setClienteEditIndex] = useState(-1);
            const [clienteForm, setClienteForm] = useState({ id: null, nome: '', tipo: 'Pessoa jurídica', documento: '', telefone: '', celular: '', email: '', situacao: true });
            
            const [modalArquivosOpen, setModalArquivosOpen] = useState(false);
            const [modalPrintOpen, setModalPrintOpen] = useState(false);
            const [printConfig, setPrintConfig] = useState({ orientation: 'landscape', scale: 100 });

            const [pdfData, setPdfData] = useState([]);
            const tabelaPdfRef = useRef(null);
            const [editRowIndex, setEditRowIndex] = useState(-1);
            const [editRowData, setEditRowData] = useState({});

            const [savedReportsList, setSavedReportsList] = useState([]);
            const [currentReportId, setCurrentReportId] = useState(null);
            const [reportName, setReportName] = useState('');
            const [reportPeriod, setReportPeriod] = useState('');

            const [usersList, setUsersList] = useState([]);
            const [modalUserOpen, setModalUserOpen] = useState(false);
            const [userForm, setUserForm] = useState({ id: null, username: '', password: '', role: 'user', permissions: [] });

            const [vendasList, setVendasList] = useState([]);
            const [showVendasFilter, setShowVendasFilter] = useState(true);
            const [showVendasPeriodMenu, setShowVendasPeriodMenu] = useState(false);
            const [vendasPeriodLabel, setVendasPeriodLabel] = useState('Todo o período');

            const [modalVendaOpen, setModalVendaOpen] = useState(false);
            const [vendaForm, setVendaForm] = useState({ 
                id: null, 
                numero: '', 
                cliente: '', 
                dataVenda: dataDeHojeInterna(), 
                situacao: 'FATURADO PROTETTA NF', 
                loja: 'PROTETTA SEGUROS', 
                valor: 0, 
                contrato: '', 
                codigoOperadora: '', 
                vidas: '', 
                vitalicio: 'Selecione', 
                parcela: '', 
                inicioVigencia: '', 
                notaFiscal: '', 
                corretor: 'Corretor Interno',
                servico: ''
            });

            const defaultVendasFilters = { 
                loja: 'Todos', 
                codigo: '', 
                dataInicio: '', 
                dataFim: '', 
                situacao: 'Todos', 
                cliente: '', 
                contrato: '', 
                codigoOperadora: '', 
                vidas: '', 
                vitalicio: 'Selecione', 
                parcela: '', 
                inicioVigencia: '', 
                notaFiscal: '', 
                corretor: 'Todos' 
            };
            const [vendasFilterForm, setVendasFilterForm] = useState(defaultVendasFilters);
            const [appliedVendasFilters, setAppliedVendasFilters] = useState(null);

            // CARREGAMENTO DE DADOS DO SUPABASE
            const loadFromDB = async () => {
                if(!supabase) return;
                try {
                    // Usando try/catch em vez de .catch() que não funciona corretamente
                    let usersData = [], clientesData = [], vendasData = [], savedData = [], reportsData = [];
                    
                    try {
                        const { data } = await supabase.from('users').select('*');
                        usersData = data || [];
                    } catch (e) { console.warn('Erro users:', e); }
                    
                    try {
                        const { data } = await supabase.from('clientes').select('*');
                        clientesData = data || [];
                    } catch (e) { console.warn('Erro clientes:', e); }
                    
                    try {
                        const { data } = await supabase.from('vendas').select('*');
                        vendasData = data || [];
                    } catch (e) { console.warn('Erro vendas:', e); }
                    
                    try {
                        const { data } = await supabase.from('savedReports').select('*');
                        savedData = data || [];
                    } catch (e) { console.warn('Erro savedReports:', e); }
                    
                    try {
                        const { data } = await supabase.from('reports').select('*');
                        reportsData = data || [];
                    } catch (e) { console.warn('Erro reports:', e); }
                    
                    setUsersList(usersData.filter(Boolean));
                    setClientes(clientesData.filter(Boolean));
                    setVendasList(vendasData.filter(Boolean));
                    setSavedReportsList(savedData.filter(Boolean));
                    setDbReports(reportsData.filter(Boolean));

                } catch (err) { 
                    console.error("Erro ao carregar Supabase:", err);
                }
            };

            // Setup Inicial do Admin
            useEffect(() => {
                const initAdmin = async () => {
                    if(!supabase) return;
                    try {
                        const { data } = await supabase.from('users').select('*').limit(1);
                        
                        if (!data || data.length === 0) {
                            await supabase.from('users').insert([{
                                username: 'admin', 
                                password: 'admin', 
                                role: 'admin', 
                                permissions: SYSTEM_MODULES.map(m => m.id)
                            }]);
                        }
                    } catch(e) { 
                        console.warn("Aviso: Não foi possível criar admin. RLS pode estar ativo."); 
                    }
                };
                initAdmin();
            }, []);

            useEffect(() => { 
                if(currentUser) loadFromDB(); 
            }, [currentUser]);
            
            useEffect(() => {
                if (isDarkMode) { 
                    document.documentElement.classList.add('dark'); 
                    localStorage.setItem('protetta_theme', 'dark'); 
                } else { 
                    document.documentElement.classList.remove('dark'); 
                    localStorage.setItem('protetta_theme', 'light'); 
                }
            }, [isDarkMode]);

            // --- LOGIN ---
            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true); setLoadingMsg("Autenticando...");
                try {
                    const { data: users, error } = await supabase.from('users').select('*').eq('username', loginData.user);
                    
                    if (error) throw error;

                    if (users && users.length > 0 && users[0] && users[0].password === loginData.password) {
                        const user = users[0];
                        
                        const finalRole = user.username === 'admin' ? 'admin' : (user.role || 'user'); 

                        const sessionUser = { 
                            id: user.id, 
                            username: user.username, 
                            role: finalRole, 
                            permissions: user.permissions || [] 
                        };
                        setCurrentUser(sessionUser);
                        localStorage.setItem('protetta_auth_user', JSON.stringify(sessionUser));
                        setLoginError('');
                        setLoginData({ user: '', password: '' });
                        setShowPassword(false);
                        
                        if (finalRole !== 'admin' && !(user.permissions || []).includes('dashboard')) {
                            if (user.permissions && user.permissions.length > 0) {
                                setCurrentView(user.permissions[0]);
                            } else {
                                setCurrentView('none');
                            }
                        } else {
                            setCurrentView('dashboard');
                        }
                    } else {
                        setLoginError('Utilizador ou senha inválidos. (Admin padrão: admin / admin)');
                    }
                } catch(err) { 
                    console.error("Erro Login:", err);
                    setLoginError(`Erro de conexão: ${err.message}`); 
                } finally { 
                    setLoading(false); 
                }
            };

            const handleLogout = () => {
                showConfirm("Tem a certeza que deseja terminar a sessão?", () => {
                    setCurrentUser(null);
                    localStorage.removeItem('protetta_auth_user');
                    setCurrentView('dashboard');
                });
            };

            // --- LÓGICA DE VENDAS ---
            const applyDatePreset = (preset) => {
                let start = '';
                let end = '';
                const today = new Date();
                
                const formatDate = (date) => {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                };

                switch(preset) {
                    case 'Hoje':
                        start = formatDate(today); end = formatDate(today); break;
                    case 'Esta semana':
                        const first = today.getDate() - today.getDay();
                        start = formatDate(new Date(today.getFullYear(), today.getMonth(), first));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth(), first + 6));
                        break;
                    case 'Mês passado':
                        start = formatDate(new Date(today.getFullYear(), today.getMonth() - 1, 1));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth(), 0));
                        break;
                    case 'Este mês':
                        start = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                        break;
                    case 'Próximo mês':
                        start = formatDate(new Date(today.getFullYear(), today.getMonth() + 1, 1));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth() + 2, 0));
                        break;
                    case 'Todo o período':
                    default:
                        start = ''; end = ''; break;
                }

                setVendasPeriodLabel(preset);
                setShowVendasPeriodMenu(false);
                
                if (preset === 'Escolha o período') {
                    setShowVendasFilter(true); 
                } else {
                    const updatedFilters = { ...vendasFilterForm, dataInicio: start, dataFim: end };
                    setVendasFilterForm(updatedFilters);
                    setAppliedVendasFilters(updatedFilters);
                }
            };

            const handleBuscarVendas = () => { setAppliedVendasFilters({ ...vendasFilterForm }); };
            const handleLimparVendas = () => {
                setVendasFilterForm(defaultVendasFilters);
                setAppliedVendasFilters(null);
                setVendasPeriodLabel('Todo o período');
            };

            const getFilteredVendas = () => {
                let todasAsVendas = [...vendasList];
                
                savedReportsList.forEach(report => {
                    if (report && report.dados && Array.isArray(report.dados)) {
                        report.dados.forEach((dado, idx) => {
                            if (dado) {
                                todasAsVendas.push({
                                    id: `rep_${report.id}_${idx}`, 
                                    isFromReport: true,
                                    reportId: report.id,
                                    reportRowIndex: idx,
                                    numero: dado.cod,
                                    cliente: dado.cliente,
                                    dataVenda: report.dataCriacao ? report.dataCriacao.split('T')[0] : dataDeHojeInterna(),
                                    situacao: dado.situacao,
                                    loja: dado.loja,
                                    valor: dado.valorTotal,
                                    contrato: '', 
                                    codigoOperadora: '', 
                                    vidas: '', 
                                    vitalicio: '', 
                                    parcela: '', 
                                    inicioVigencia: '', 
                                    notaFiscal: '', 
                                    corretor: ''
                                });
                            }
                        });
                    }
                });

                if (appliedVendasFilters) {
                    const f = appliedVendasFilters;
                    if (f.loja !== 'Todos') todasAsVendas = todasAsVendas.filter(v => v?.loja === f.loja);
                    if (f.situacao !== 'Todos') todasAsVendas = todasAsVendas.filter(v => v?.situacao === f.situacao);
                    if (f.codigo) todasAsVendas = todasAsVendas.filter(v => (v?.numero || '').toLowerCase().includes(f.codigo.toLowerCase()));
                    if (f.cliente) todasAsVendas = todasAsVendas.filter(v => (v?.cliente || '').toLowerCase().includes(f.cliente.toLowerCase()));
                    if (f.contrato) todasAsVendas = todasAsVendas.filter(v => (v?.contrato || '').toLowerCase().includes(f.contrato.toLowerCase()));
                    if (f.codigoOperadora) todasAsVendas = todasAsVendas.filter(v => (v?.codigoOperadora || '').toLowerCase().includes(f.codigoOperadora.toLowerCase()));
                    if (f.notaFiscal) todasAsVendas = todasAsVendas.filter(v => (v?.notaFiscal || '').toLowerCase().includes(f.notaFiscal.toLowerCase()));
                    if (f.vidas) todasAsVendas = todasAsVendas.filter(v => String(v?.vidas || '') === String(f.vidas));
                    if (f.vitalicio !== 'Selecione') todasAsVendas = todasAsVendas.filter(v => v?.vitalicio === f.vitalicio);
                    if (f.corretor !== 'Todos') todasAsVendas = todasAsVendas.filter(v => v?.corretor === f.corretor);
                    if (f.dataInicio) todasAsVendas = todasAsVendas.filter(v => v?.dataVenda >= f.dataInicio);
                    if (f.dataFim) todasAsVendas = todasAsVendas.filter(v => v?.dataVenda <= f.dataFim);
                }
                
                todasAsVendas.sort((a, b) => new Date(b?.dataVenda || 0) - new Date(a?.dataVenda || 0));
                return todasAsVendas;
            };

            const displayedVendas = getFilteredVendas();

            let displayPeriodLabel = vendasPeriodLabel;
            if (vendasPeriodLabel === 'Escolha o período' && appliedVendasFilters?.dataInicio && appliedVendasFilters?.dataFim) {
                 displayPeriodLabel = `${formatarDataVisivel(appliedVendasFilters.dataInicio)} - ${formatarDataVisivel(appliedVendasFilters.dataFim)}`;
            } else if (vendasPeriodLabel === 'Escolha o período') {
                 displayPeriodLabel = 'Período Customizado';
            }

            const getSituacaoColor = (situacao) => {
                if (!situacao) return 'bg-slate-100 text-slate-700';
                if (situacao.includes('FATURADO')) return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-400';
                if (situacao.includes('PENDENTE')) return 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400';
                if (situacao.includes('CANCELADO')) return 'bg-rose-100 text-rose-700 dark:bg-rose-500/20 dark:text-rose-400';
                return 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300';
            };

            const abrirModalVenda = (venda = null) => {
                if (venda) {
                    setVendaForm({ ...venda });
                } else {
                    setVendaForm({ 
                        id: null, 
                        numero: Math.floor(10000 + Math.random() * 90000).toString(), 
                        cliente: '', 
                        dataVenda: dataDeHojeInterna(), 
                        situacao: 'FATURADO PROTETTA NF', 
                        loja: 'PROTETTA SEGUROS', 
                        valor: 0, 
                        contrato: '', 
                        codigoOperadora: '', 
                        vidas: '', 
                        vitalicio: 'Selecione', 
                        parcela: '', 
                        inicioVigencia: '', 
                        notaFiscal: '', 
                        corretor: 'Corretor Interno',
                        servico: ''
                    });
                }
                setModalVendaOpen(true);
            };

            const salvarVenda = async (e) => {
                e.preventDefault();
                setLoading(true); setLoadingMsg("Guardando venda...");
                try {
                    const dataToSave = { 
                        ...vendaForm, 
                        valor: parseFloat(vendaForm.valor) || 0,
                        vidas: vendaForm.vidas ? String(vendaForm.vidas) : ''
                    };
                    delete dataToSave.id;

                    if (vendaForm.isFromReport) {
                        const { data: rep } = await supabase.from('savedReports').select('*').eq('id', vendaForm.reportId).single();
                        if (rep) {
                            let dadosAtualizados = [...rep.dados];
                            dadosAtualizados[vendaForm.reportRowIndex] = {
                                ...dadosAtualizados[vendaForm.reportRowIndex],
                                cod: dataToSave.numero, 
                                cliente: dataToSave.cliente, 
                                situacao: dataToSave.situacao,
                                loja: dataToSave.loja, 
                                valorTotal: dataToSave.valor
                            };
                            await supabase.from('savedReports').update({ dados: dadosAtualizados }).eq('id', rep.id);
                        }
                    } else if (vendaForm.id) {
                        await supabase.from('vendas').update(dataToSave).eq('id', vendaForm.id);
                    } else {
                        await supabase.from('vendas').insert([dataToSave]);
                    }
                    
                    await loadFromDB();
                    setModalVendaOpen(false);
                    showAlert("Venda guardada com sucesso!");
                } catch (err) { 
                    showAlert("Erro ao guardar: " + err.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const apagarVenda = (venda) => {
                showConfirm(`Tem a certeza que deseja apagar permanentemente este registo?`, async () => {
                    setLoading(true); setLoadingMsg("Apagando...");
                    try {
                        if (venda.isFromReport) {
                            const { data: rep } = await supabase.from('savedReports').select('*').eq('id', venda.reportId).single();
                            if (rep) {
                                let dados = rep.dados.filter((_, idx) => idx !== venda.reportRowIndex);
                                await supabase.from('savedReports').update({ dados: dados }).eq('id', rep.id);
                            }
                        } else {
                            await supabase.from('vendas').delete().eq('id', venda.id);
                        }
                        await loadFromDB();
                    } catch (err) {
                        showAlert("Erro ao apagar: " + err.message);
                    } finally {
                        setLoading(false);
                    }
                });
            };

            // --- FUNÇÕES DE USUÁRIOS ---
            const abrirModalUsuario = (user = null) => {
                if (user) {
                    setUserForm({ ...user });
                } else {
                    setUserForm({ id: null, username: '', password: '', role: 'user', permissions: [] });
                }
                setModalUserOpen(true);
            };

            const salvarUsuario = async (e) => {
                e.preventDefault();
                setLoading(true); setLoadingMsg("Guardando utilizador...");
                try {
                    const { data: existing } = await supabase.from('users').select('*').eq('username', userForm.username);

                    if (existing && existing.length > 0 && existing[0].id !== userForm.id) {
                        setLoading(false); 
                        return showAlert("Já existe um utilizador registado com este nome.");
                    }
                    
                    const dataToSave = {
                        username: userForm.username, 
                        password: userForm.password, 
                        role: userForm.role,
                        permissions: userForm.role === 'admin' ? SYSTEM_MODULES.map(m => m.id) : (userForm.permissions || [])
                    };

                    if (userForm.id) {
                        await supabase.from('users').update(dataToSave).eq('id', userForm.id);
                        if (currentUser?.id === userForm.id) {
                            const updatedSession = { ...currentUser, ...dataToSave };
                            setCurrentUser(updatedSession);
                            localStorage.setItem('protetta_auth_user', JSON.stringify(updatedSession));
                        }
                    } else { 
                        await supabase.from('users').insert([dataToSave]); 
                    }
                    
                    await loadFromDB(); 
                    setModalUserOpen(false); 
                    showAlert("Utilizador guardado com sucesso!");
                } catch (err) { 
                    showAlert("Erro ao guardar: " + err.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const apagarUsuario = (u) => {
                if (u.username === 'admin') return showAlert("Proteção: Não é possível apagar a conta admin.");
                if (currentUser?.id === u.id) return showAlert("Você não pode apagar a sua própria conta.");
                showConfirm(`Tem a certeza que deseja apagar '${u?.username || 'Desconhecido'}'?`, async () => {
                    await supabase.from('users').delete().eq('id', u.id); 
                    await loadFromDB();
                });
            };

            // --- FUNÇÕES: GESTOR DE EXTRATOS ---
            const [formData, setFormData] = useState({ 
                ano: new Date().getFullYear().toString(), 
                mes: MESES[0], 
                categoria: CATEGORIAS[0], 
                empresa: EMPRESAS_INTERNAS[0], 
                parceiro: '', 
                arquivos: [] 
            });
            const [formError, setFormError] = useState('');
            const [successMsg, setSuccessMsg] = useState('');
            const fileInputRef = useRef(null);

            const getFileColorClass = (fileName) => {
                if (!fileName) return "text-slate-400";
                const ext = fileName.split('.').pop().toLowerCase();
                if (['csv', 'xlsx', 'xls'].includes(ext)) return "text-emerald-600 dark:text-emerald-400";
                if (['pdf'].includes(ext)) return "text-rose-600 dark:text-rose-400";
                return "text-slate-400";
            };

            const getItemsAtCurrentPath = () => {
                if (searchTerm.trim() !== '') {
                    const term = searchTerm.toLowerCase();
                    return dbReports.filter(r => r && (
                        (r.parceiro && r.parceiro.toLowerCase().includes(term)) || 
                        (r.fileName && r.fileName.toLowerCase().includes(term)) || 
                        (r.empresa && r.empresa.toLowerCase().includes(term))
                    )).map(f => ({ ...f, type: 'file', pathInfo: `${f.ano} / ${f.mes} / ${f.empresa}` }));
                }
                if (currentPath.length === 0) return [...new Set(dbReports.filter(Boolean).map(r => r.ano))].sort().map(y => ({ id: y, name: y, type: 'folder' }));
                if (currentPath.length === 1) return [...new Set(dbReports.filter(r => r && r.ano === currentPath[0]).map(r => r.mes))].sort((a, b) => MESES.indexOf(a) - MESES.indexOf(b)).map(m => ({ id: m, name: m, type: 'folder' }));
                if (currentPath.length === 2) return CATEGORIAS.map(c => ({ id: c, name: c, type: 'folder' }));
                if (currentPath.length === 3) return EMPRESAS_INTERNAS.map(e => ({ id: e, name: e, type: 'folder' }));
                if (currentPath.length === 4) return dbReports.filter(r => r && r.ano === currentPath[0] && r.mes === currentPath[1] && r.categoria === currentPath[2] && r.empresa === currentPath[3]).map(f => ({ ...f, type: 'file', name: f.parceiro }));
                return [];
            };

            const handleSubmitExtrato = async (e) => {
                e.preventDefault();
                if (!formData.parceiro.trim()) return setFormError('ERRO: Parceiro obrigatório.');
                if (formData.arquivos.length === 0) return setFormError('ERRO: Anexos obrigatórios.');
                
                setLoading(true); 
                setLoadingMsg("Fazendo upload...");
                
                try {
                    // Verifica se o bucket existe e cria se necessário
                    try {
                        await supabase.storage.createBucket('documentos', { 
                            public: true,
                            allowedMimeTypes: ['application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv']
                        });
                    } catch (e) {
                        console.log('Bucket pode já existir:', e);
                    }

                    for (const file of formData.arquivos) {
                        const filePath = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                        
                        // Upload para storage
                        const { error: uploadErr } = await supabase.storage
                            .from('documentos')
                            .upload(filePath, file, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if(uploadErr) {
                            console.error('Erro upload:', uploadErr);
                            throw uploadErr;
                        }
                        
                        // Inserir na tabela reports
                        const { error: insertErr } = await supabase
                            .from('reports')
                            .insert([{ 
                                ano: formData.ano, 
                                mes: formData.mes, 
                                categoria: formData.categoria, 
                                empresa: formData.empresa, 
                                parceiro: formData.parceiro, 
                                date: new Date().toISOString(), 
                                fileName: file.name, 
                                filePath: filePath 
                            }]);

                        if(insertErr) {
                            console.error('Erro insert:', insertErr);
                            throw insertErr;
                        }
                    }
                    
                    await loadFromDB();
                    setSuccessMsg(`${formData.arquivos.length} extratos guardados!`);
                    setFormData(prev => ({ ...prev, parceiro: '', arquivos: [] }));
                    setTimeout(() => setSuccessMsg(''), 4000);
                } catch (error) { 
                    console.error('Erro completo:', error);
                    showAlert("Erro ao enviar: " + error.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const handleNavigate = async (item) => {
                if (item.type === 'folder') { 
                    setCurrentPath([...currentPath, item.name]); 
                    setSearchTerm(''); 
                } else if (item.type === 'file') {
                    setLoading(true); 
                    setLoadingMsg("Descarregando...");
                    try { 
                        const { data, error } = await supabase.storage.from('documentos').download(item.filePath);
                        if(error) throw error;
                        setSelectedFile({ ...item, fileObj: data }); 
                    } catch(e) { 
                        console.error('Erro download:', e);
                        showAlert("Erro ao descarregar: " + e.message); 
                    } finally { 
                        setLoading(false); 
                    }
                }
            };

            // --- FUNÇÕES: CLIENTES ---
            const clientesFiltrados = clientes.filter(cli => cli && cli.nome && cli.nome.toLowerCase().includes(filtroNomeCliente.toLowerCase()));

            const apagarCliente = (id) => {
                showConfirm("Tem a certeza que deseja apagar este cliente?", async () => {
                    setLoading(true); 
                    setLoadingMsg("Apagando cliente...");
                    try {
                        await supabase.from('clientes').delete().eq('id', id);
                        await loadFromDB(); 
                    } catch (err) {
                        showAlert("Erro: " + err.message);
                    } finally {
                        setLoading(false);
                    }
                });
            };

            const abrirModalAddEdit = (cliente = null) => {
                if (cliente) { 
                    setClienteForm({...cliente}); 
                    setClienteEditIndex(cliente.id); 
                } else { 
                    setClienteForm({ 
                        id: null, 
                        nome: '', 
                        tipo: 'Pessoa jurídica', 
                        documento: '', 
                        telefone: '', 
                        celular: '', 
                        email: '', 
                        situacao: true 
                    }); 
                    setClienteEditIndex(-1); 
                }
                setModalClienteOpen(true);
            };

            const salvarCliente = async (e) => {
                e.preventDefault();
                setLoading(true); 
                setLoadingMsg("Guardando cliente...");
                try {
                    const clienteParaSalvar = { ...clienteForm };
                    clienteParaSalvar.nome = clienteParaSalvar.nome.trim();

                    if (clienteEditIndex >= 0) {
                        const duplicado = clientes.find(c => c && c.id !== clienteEditIndex && c.nome.toLowerCase() === clienteParaSalvar.nome.toLowerCase());
                        if (duplicado) { 
                            setLoading(false); 
                            return showAlert("Já existe outro cliente registado com este nome exato."); 
                        }
                        
                        await supabase.from('clientes').update(clienteParaSalvar).eq('id', clienteEditIndex);
                    } else {
                        const duplicado = clientes.find(c => c && c.nome.toLowerCase() === clienteParaSalvar.nome.toLowerCase());
                        if (duplicado) { 
                            setLoading(false); 
                            return showAlert("Já existe um cliente com este nome."); 
                        }
                        
                        const novoCliente = {
                            ...clienteParaSalvar,
                            codigo: Math.floor(10000 + Math.random() * 90000).toString(),
                            cadastradoEm: dataDeHojeInterna()
                        };
                        delete novoCliente.id;
                        await supabase.from('clientes').insert([novoCliente]);
                    }
                    await loadFromDB(); 
                    setModalClienteOpen(false);
                } catch (err) { 
                    showAlert("Erro ao guardar cliente: " + err.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const importarClientes = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setLoading(true); 
                setLoadingMsg("Lendo ficheiro...");
                const ext = file.name.split('.').pop().toLowerCase();
                try {
                    let novosClientesParaInserir = [];
                    
                    if (ext === 'xlsx' || ext === 'csv') {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data);
                        const linhasExcel = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        
                        linhasExcel.forEach(linha => {
                            let nome = linha['Nome'] || linha['NOME'] || linha['Cliente'] || "Sem Nome";
                            nome = nome.trim();
                            if(!clientes.find(c => c && c.nome && c.nome.toLowerCase() === nome.toLowerCase()) && 
                               !novosClientesParaInserir.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                                novosClientesParaInserir.push({
                                    codigo: Math.floor(10000 + Math.random() * 90000).toString(),
                                    nome: nome, 
                                    tipo: linha['Tipo'] || 'Pessoa jurídica', 
                                    documento: linha['Documento'] || linha['CNPJ'] || linha['NIF'] || '',
                                    telefone: linha['Telefone'] || '', 
                                    celular: linha['Celular'] || '', 
                                    email: linha['Email'] || linha['E-mail'] || '',
                                    situacao: true, 
                                    cadastradoEm: dataDeHojeInterna() 
                                });
                            }
                        });
                    }

                    if(novosClientesParaInserir.length > 0){
                        await supabase.from('clientes').insert(novosClientesParaInserir);
                        await loadFromDB();
                        showAlert(`${novosClientesParaInserir.length} novos clientes importados!`);
                    } else {
                        showAlert("Nenhum cliente novo encontrado.");
                    }
                } catch (err) { 
                    showAlert("Erro ao importar: " + err.message); 
                } finally { 
                    setLoading(false); 
                    event.target.value = ''; 
                }
            };

            // --- FUNÇÕES: PROCESSAR EXTRATO ---
            const processarArquivoDoBanco = async (report) => {
                setLoading(true); 
                setLoadingMsg("A descarregar PDF...");
                setModalArquivosOpen(false); 
                try {
                    const { data: fileBlob, error } = await supabase.storage.from('documentos').download(report.filePath);
                    if (error || !fileBlob) throw new Error("Ficheiro não encontrado.");
                    
                    setLoadingMsg("A processar dados do PDF...");
                    const arrayBuffer = await fileBlob.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let textoCompleto = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        textoCompleto += textContent.items.map(item => item.str).join(" ") + " ";
                    }
                    await extrairDadosDoTexto(textoCompleto);
                } catch (error) { 
                    showAlert("Erro ao ler o PDF: " + error.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const extrairDadosDoTexto = async (texto) => {
                setCurrentReportId(null); 
                setReportName(`Relatório Automático - ${new Date().toLocaleDateString('pt-PT')}`);
                setReportPeriod('');

                let textoNormalizado = texto.replace(/\s+/g, ' ').trim();
                let textoSemFalsoContrato = textoNormalizado.replace(/Total\s+contrato\s*:/gi, 'Total_Apurado:');
                const blocosContrato = textoSemFalsoContrato.split(/Contrato\s*:/i);
                if (blocosContrato.length > 0) blocosContrato.shift();

                const novosRegistos = [];
                const clientesParaInserir = [];
                const nomesClientesExistem = new Set(clientes.filter(Boolean).map(c => c.nome.toLowerCase()));

                for (let bloco of blocosContrato) {
                    try {
                        bloco = bloco.trim(); 
                        if (bloco === "") continue;
                        let codCliente = "N/D", nomeCliente = "";
                        
                        const matchNome = bloco.match(/^(\d+)\s*(?:-)?\s*(.+?)(?=\s+Fatura|\s+Proposta|\s+Data|\s+Qtd|\s+Forma|\s+\d{2}\/\d{4})/i);
                        if (matchNome) { 
                            codCliente = matchNome[1].trim(); 
                            nomeCliente = matchNome[2].trim(); 
                            nomeCliente = nomeCliente.replace(/(?:\s+[\d\/\.\-,]+)+$/, '').trim();
                        }
                        if(!nomeCliente) continue;

                        if(!nomesClientesExistem.has(nomeCliente.toLowerCase())) {
                            nomesClientesExistem.add(nomeCliente.toLowerCase());
                            clientesParaInserir.push({
                                codigo: codCliente, 
                                nome: nomeCliente, 
                                tipo: 'Pessoa jurídica', 
                                documento: codCliente, 
                                telefone: '', 
                                celular: '', 
                                email: '', 
                                situacao: true, 
                                cadastradoEm: dataDeHojeInterna() 
                            });
                        }

                        let valorTotal = 0, comissao = 0;
                        const regexValores = /Sem Repique\s+(\d{1,2},\d{2})\s+([\d\.]+,\d{2})\s+([\d\.]+,\d{2})/i;
                        let matchValores = regexValores.exec(bloco);
                        if (matchValores) {
                            valorTotal = parseFloat(matchValores[2].replace(/\./g, '').replace(',', '.'));
                            comissao = parseFloat(matchValores[3].replace(/\./g, '').replace(',', '.')); 
                        } else {
                            const regexFallback = /(\d{1,2},\d{2})\s+([\d\.]+,\d{2})\s+([\d\.]+,\d{2})\s+Médico/i;
                            let matchFallback = regexFallback.exec(bloco);
                            if(matchFallback){
                                valorTotal = parseFloat(matchFallback[2].replace(/\./g, '').replace(',', '.'));
                                comissao = parseFloat(matchFallback[3].replace(/\./g, '').replace(',', '.'));
                            }
                        }

                        if (valorTotal > 0) {
                            novosRegistos.push({ 
                                cod: codCliente, 
                                cliente: nomeCliente, 
                                data: "01/2026", 
                                situacao: "FATURADO PROTETTA NF", 
                                loja: "PROTETTA", 
                                valorTotal, 
                                comissao 
                            });
                        }
                    } catch (e) { console.warn("Erro bloco:", e); }
                }
                
                if(clientesParaInserir.length > 0) {
                    try {
                        await supabase.from('clientes').insert(clientesParaInserir);
                        await loadFromDB();
                    } catch (e) {
                        console.warn("Erro ao inserir clientes:", e);
                    }
                }
                setPdfData(novosRegistos);
                showAlert("Extrato processado com sucesso!");
            };

            const startEditingRow = (idx, linha) => { 
                setEditRowIndex(idx); 
                setEditRowData({...linha}); 
            };
            
            const saveRowEdit = () => {
                const newData = [...pdfData];
                newData[editRowIndex] = { 
                    ...editRowData, 
                    valorTotal: parseFloat(editRowData.valorTotal) || 0, 
                    comissao: parseFloat(editRowData.comissao) || 0 
                };
                setPdfData(newData); 
                setEditRowIndex(-1);
            };
            
            const cancelRowEdit = () => setEditRowIndex(-1);
            
            const deleteRowFromReport = (idx) => {
                showConfirm("Deseja apagar esta linha do relatório?", () => {
                    setPdfData(prev => prev.filter((_, i) => i !== idx));
                    if (editRowIndex === idx) setEditRowIndex(-1);
                    else if (editRowIndex > idx) setEditRowIndex(editRowIndex - 1);
                });
            };
            
            const addManualRow = () => {
                const novaLinha = { 
                    cod: '', 
                    cliente: 'Novo Cliente', 
                    data: '', 
                    situacao: 'FATURADO PROTETTA NF', 
                    loja: 'PROTETTA', 
                    valorTotal: 0, 
                    comissao: 0 
                };
                const newData = [...pdfData, novaLinha];
                setPdfData(newData); 
                setEditRowIndex(newData.length - 1); 
                setEditRowData(novaLinha);
            };

            const salvarRelatorioComissao = async () => {
                if(!reportName) return showAlert('Digite um nome para o relatório.');
                if(pdfData.length === 0) return showAlert('Não há dados para salvar.');
                
                const dataToSave = { 
                    nome: reportName, 
                    periodo: reportPeriod, 
                    dataCriacao: new Date().toISOString(), 
                    dados: pdfData 
                };
                
                setLoading(true); 
                setLoadingMsg("Guardando relatório...");
                
                try {
                    if (currentReportId) {
                        await supabase.from('savedReports').update(dataToSave).eq('id', currentReportId);
                    } else { 
                        const { data } = await supabase.from('savedReports').insert([dataToSave]).select(); 
                        if(data) setCurrentReportId(data[0].id); 
                    }
                    await loadFromDB(); 
                    setSuccessMsg("Relatório salvo com sucesso!");
                    setTimeout(() => setSuccessMsg(''), 3000);
                } catch(e) { 
                    showAlert('Erro ao salvar: ' + e.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            const carregarRelatorioSalvo = (report) => {
                setPdfData(report.dados || []); 
                setReportName(report.nome); 
                setReportPeriod(report.periodo || ''); 
                setCurrentReportId(report.id); 
                setCurrentView('processar');
            };

            const apagarRelatorioSalvo = (id) => {
                showConfirm("Tem certeza que deseja excluir permanentemente este relatório?", async () => {
                    setLoading(true); 
                    setLoadingMsg("A apagar...");
                    try {
                        await supabase.from('savedReports').delete().eq('id', id);
                        if(currentReportId === id) { 
                            setPdfData([]); 
                            setCurrentReportId(null); 
                        }
                        await loadFromDB();
                    } catch (e) {
                        showAlert("Erro: " + e.message);
                    } finally {
                        setLoading(false);
                    }
                });
            };

            // --- IMPRESSÃO ---
            const handlePrintConfirm = () => {
                const printElement = document.getElementById('print-section');
                if (!printElement) return;

                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    showAlert("Permita pop-ups para imprimir.");
                    return;
                }

                const htmlContent = printElement.innerHTML;

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="pt-PT">
                    <head>
                        <title>Relatório de Comissão</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>
                            @page { size: ${printConfig.orientation}; margin: 10mm; }
                            body { background-color: white !important; color: black !important; }
                            .print-wrapper { transform: scale(${printConfig.scale / 100}); transform-origin: top left; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #94a3b8 !important; padding: 8px 12px; }
                            th { background-color: #f1f5f9 !important; }
                            .no-print { display: none !important; }
                        </style>
                    </head>
                    <body class="p-8 bg-white">
                        <div class="print-wrapper">
                            ${htmlContent}
                        </div>
                        <script>
                            setTimeout(() => {
                                window.document.close();
                                window.focus();
                                window.print();
                            }, 800);
                        <\/script>
                    </body>
                    </html>
                `);
                setModalPrintOpen(false); 
            };

            // --- RENDERIZAÇÃO PRINCIPAL (SIMPLIFICADA PARA TESTE) ---
            return (
                <div className="flex h-full bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans overflow-hidden">
                    
                    {/* MODAIS DE ALERTA */}
                    {alertDialog.isOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-slate-200 dark:border-slate-700">
                                <h3 className="text-lg font-bold mb-3 text-slate-900 dark:text-white flex items-center">
                                    <Icons.AlertCircle className="mr-2 text-blue-500"/> Aviso
                                </h3>
                                <p className="text-sm text-slate-700 dark:text-slate-300 mb-6 whitespace-pre-wrap">{alertDialog.message}</p>
                                <div className="flex justify-end">
                                    <button onClick={() => setAlertDialog({ isOpen: false, message: '' })} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold">
                                        OK
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {confirmDialog.isOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-slate-200 dark:border-slate-700">
                                <h3 className="text-lg font-bold mb-3 text-slate-900 dark:text-white flex items-center">
                                    <Icons.AlertCircle className="mr-2 text-amber-500"/> Confirmação
                                </h3>
                                <p className="text-sm text-slate-700 dark:text-slate-300 mb-6 whitespace-pre-wrap">{confirmDialog.message}</p>
                                <div className="flex justify-end gap-3">
                                    <button onClick={() => setConfirmDialog({ isOpen: false, message: '', onConfirm: null })} className="bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-300 dark:hover:bg-slate-600">
                                        Cancelar
                                    </button>
                                    <button onClick={() => { if(confirmDialog.onConfirm) confirmDialog.onConfirm(); setConfirmDialog({ isOpen: false, message: '', onConfirm: null }); }} className="bg-rose-600 hover:bg-rose-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg">
                                        Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {loading && (
                        <div className="fixed inset-0 z-[60] bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center">
                            <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p className="text-slate-800 dark:text-white font-medium animate-pulse">{loadingMsg}</p>
                        </div>
                    )}

                    {/* TELA DE LOGIN */}
                    {!currentUser ? (
                        <div className="flex items-center justify-center w-full h-full bg-gradient-to-br from-slate-900 to-slate-800">
                            <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-200 dark:border-slate-700">
                                <div className="text-center mb-8">
                                    <div className="bg-emerald-600 w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                                        <span className="text-3xl font-bold text-white">D</span>
                                    </div>
                                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Don Gestão</h2>
                                    <p className="text-slate-500 dark:text-slate-400 mt-1">Sistema de Gestão Cloud</p>
                                </div>
                                
                                <form onSubmit={handleLogin} className="space-y-5">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Utilizador</label>
                                        <input
                                            type="text"
                                            value={loginData.user}
                                            onChange={(e) => setLoginData({...loginData, user: e.target.value})}
                                            className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white focus:border-emerald-500 outline-none"
                                            placeholder="admin"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Palavra-passe</label>
                                        <div className="relative">
                                            <input
                                                type={showPassword ? "text" : "password"}
                                                value={loginData.password}
                                                onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                                                className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg pl-4 pr-10 py-2 text-slate-900 dark:text-white focus:border-emerald-500 outline-none"
                                                placeholder="••••••"
                                                required
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setShowPassword(!showPassword)}
                                                className="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
                                            >
                                                {showPassword ? <Icons.EyeOff size={18} /> : <Icons.Eye size={18} />}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {loginError && (
                                        <div className="bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 p-3 rounded-lg text-sm">
                                            {loginError}
                                        </div>
                                    )}
                                    
                                    <button
                                        type="submit"
                                        className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2.5 rounded-lg transition-colors flex items-center justify-center"
                                    >
                                        <Icons.LogOut size={18} className="mr-2 rotate-180" />
                                        Entrar no Sistema
                                    </button>
                                </form>
                                
                                <p className="text-xs text-center text-slate-500 dark:text-slate-400 mt-6">
                                    Admin padrão: admin / admin
                                </p>
                            </div>
                        </div>
                    ) : (
                        // SISTEMA PRINCIPAL
                        <div className="flex h-full w-full">
                            {/* SIDEBAR */}
                            <aside className="w-64 bg-white dark:bg-slate-950 border-r border-slate-200 dark:border-slate-800 flex flex-col p-4 hidden md:flex shrink-0">
                                <div className="flex items-center space-x-2 px-2 mb-8 mt-2">
                                    <div className="bg-emerald-600 p-2 rounded-lg font-bold text-white leading-none border border-emerald-400/50">D</div>
                                    <div>
                                        <h1 className="text-lg font-bold text-slate-900 dark:text-white leading-tight">Don Gestão</h1>
                                        <p className="text-xs text-slate-500 flex items-center mt-0.5">
                                            <Icons.User size={12} className="mr-1"/> {currentUser?.username || 'Sessão'}
                                        </p>
                                    </div>
                                </div>
                                
                                <nav className="flex-1 space-y-1 overflow-y-auto pr-2">
                                    <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase px-4 pt-2 mb-2">Principal</p>
                                    {hasAccess('dashboard') && <SidebarItem icon={Icons.Home} label="Dashboard" active={currentView === 'dashboard'} onClick={() => setCurrentView('dashboard')} />}
                                    {hasAccess('vendas') && <SidebarItem icon={Icons.ShoppingCart} label="Vendas de Serviços" active={currentView === 'vendas'} onClick={() => setCurrentView('vendas')} />}
                                    {hasAccess('clientes') && <SidebarItem icon={Icons.Users} label="Clientes" active={currentView === 'clientes'} onClick={() => setCurrentView('clientes')} />}
                                    {hasAccess('processar') && <SidebarItem icon={Icons.FileCheck} label="Relatórios de Comissão" active={currentView === 'processar'} onClick={() => setCurrentView('processar')} />}
                                    {hasAccess('historico') && <SidebarItem icon={Icons.History} label="Relatórios Salvos" active={currentView === 'historico'} onClick={() => setCurrentView('historico')} />}
                                    
                                    {hasAccess('gestor') && <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase px-4 pt-6 mb-2">Gestor de Extratos</p>}
                                    {hasAccess('gestor') && <SidebarItem icon={Icons.Plus} label="Incluir Extrato" active={currentView === 'gestor-add'} onClick={() => { setCurrentView('gestor-add'); setSuccessMsg(''); }} />}
                                    {hasAccess('gestor') && <SidebarItem icon={Icons.FolderTree} label="Consultar Extratos" active={currentView === 'gestor-browse'} onClick={() => { setCurrentPath([]); setCurrentView('gestor-browse'); setSearchTerm(''); }} />}
                                    
                                    {(hasAccess('settings') || hasAccess('usuarios')) && <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase px-4 pt-6 mb-2">Sistema</p>}
                                    {hasAccess('usuarios') && <SidebarItem icon={Icons.Shield} label="Controle de Acessos" active={currentView === 'usuarios'} onClick={() => setCurrentView('usuarios')} />}
                                    {hasAccess('settings') && <SidebarItem icon={Icons.Settings} label="Configurações (Backup)" active={currentView === 'settings'} onClick={() => setCurrentView('settings')} />}
                                </nav>

                                <div className="mt-auto pt-4 border-t border-slate-200 dark:border-slate-800 space-y-2">
                                    <button onClick={() => setIsDarkMode(!isDarkMode)} className="w-full flex items-center justify-between px-4 py-3 rounded-lg transition-colors text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white">
                                        <div className="flex items-center space-x-3">
                                            {isDarkMode ? <Icons.Moon size={20} /> : <Icons.Sun size={20} />}
                                            <span className="font-medium text-sm">{isDarkMode ? 'Tema Clássico' : 'Tema Claro'}</span>
                                        </div>
                                        <div className={`w-10 h-5 rounded-full relative transition-colors duration-300 ${isDarkMode ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                                            <div className={`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-300 shadow-sm ${isDarkMode ? 'translate-x-5' : ''}`}></div>
                                        </div>
                                    </button>
                                    
                                    <button onClick={handleLogout} className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors text-rose-600 dark:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/30">
                                        <Icons.LogOut size={20} />
                                        <span className="font-medium text-sm">Terminar Sessão</span>
                                    </button>
                                </div>
                            </aside>

                            {/* CONTEÚDO PRINCIPAL */}
                            <main className="flex-1 overflow-auto bg-slate-50 dark:bg-slate-900 p-4 md:p-8 relative">
                                
                                {/* VIEW: GESTOR DE EXTRATOS (ADD) */}
                                {currentView === 'gestor-add' && hasAccess('gestor') && (
                                    <div className="max-w-3xl mx-auto pb-20">
                                        <header className="mb-8 border-b border-slate-200 dark:border-slate-700 pb-4">
                                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-2 flex items-center">
                                                <Icons.FolderTree className="mr-3 text-amber-500"/>Arquivar Novo Extrato
                                            </h2>
                                            <p className="text-slate-500 dark:text-slate-400">Guarde ficheiros organizados por data e parceiro.</p>
                                        </header>
                                        <form onSubmit={handleSubmitExtrato} className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6 shadow-xl space-y-6">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="space-y-2">
                                                    <label className="text-sm font-medium text-slate-600 dark:text-slate-300">Ano</label>
                                                    <input type="number" value={formData.ano} onChange={(e) => setFormData({...formData, ano: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500" />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-sm font-medium text-slate-600 dark:text-slate-300">Mês</label>
                                                    <select value={formData.mes} onChange={(e) => setFormData({...formData, mes: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500">
                                                        {MESES.map(m => <option key={m} value={m}>{m}</option>)}
                                                    </select>
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-sm font-medium text-slate-600 dark:text-slate-300">Categoria</label>
                                                    <select value={formData.categoria} onChange={(e) => setFormData({...formData, categoria: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500">
                                                        {CATEGORIAS.map(c => <option key={c} value={c}>{c}</option>)}
                                                    </select>
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-sm font-medium text-slate-600 dark:text-slate-300">Empresa</label>
                                                    <select value={formData.empresa} onChange={(e) => setFormData({...formData, empresa: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500">
                                                        {EMPRESAS_INTERNAS.map(e => <option key={e} value={e}>{e}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="space-y-2 pt-4 border-t border-slate-200 dark:border-slate-700">
                                                <label className="text-sm font-bold text-blue-600 dark:text-blue-400">NOME DO PARCEIRO</label>
                                                <input type="text" value={formData.parceiro} onChange={(e) => setFormData({...formData, parceiro: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-3 text-slate-900 dark:text-white outline-none focus:border-blue-500" placeholder="Ex: Extrato Amil Mensal..." />
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-sm font-medium text-slate-600 dark:text-slate-300">Ficheiros Anexos</label>
                                                <div onClick={() => fileInputRef.current?.click()} className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-750 hover:border-blue-500">
                                                    <Icons.Layers size={24} className="text-slate-400 mb-2" />
                                                    <p className="text-sm text-slate-500 dark:text-slate-300">Clique para anexar (PDF, Excel)</p>
                                                </div>
                                                <input type="file" ref={fileInputRef} onChange={(e)=>{ 
                                                    const newFiles = Array.from(e.target.files); 
                                                    if(newFiles.length>0){
                                                        setFormData(prev=>({...prev, arquivos: [...prev.arquivos, ...newFiles]})); 
                                                        setFormError('');
                                                    } 
                                                    if(fileInputRef.current) fileInputRef.current.value=""; 
                                                }} className="hidden" multiple accept=".pdf,.csv,.xlsx,.xls" />
                                                {formData.arquivos.length > 0 && (
                                                    <div className="mt-2 space-y-2">
                                                        {formData.arquivos.map((f, i) => (
                                                            <div key={i} className="bg-slate-50 dark:bg-slate-900 p-2 rounded border border-slate-200 dark:border-slate-700 flex justify-between items-center">
                                                                <span className="text-xs text-slate-700 dark:text-slate-300 truncate">{f?.name || ''}</span>
                                                                <button type="button" onClick={() => setFormData(prev => ({...prev, arquivos: prev.arquivos.filter((_, idx) => idx !== i)}))} className="text-rose-500 dark:text-rose-400">
                                                                    <Icons.X size={14} />
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            {formError && <p className="text-rose-500 dark:text-rose-400 text-sm font-medium">{formError}</p>}
                                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                                                <Icons.Save size={20} />
                                                <span>Guardar Extrato</span>
                                            </button>
                                            {successMsg && <div className="bg-emerald-100 dark:bg-emerald-500/20 text-emerald-700 dark:text-emerald-300 p-3 rounded-lg text-center font-bold">{successMsg}</div>}
                                        </form>
                                    </div>
                                )}

                                {/* VIEW: GESTOR DE EXTRATOS (BROWSE) */}
                                {currentView === 'gestor-browse' && hasAccess('gestor') && (
                                    <div className="max-w-6xl mx-auto pb-20">
                                        <header className="mb-6 flex flex-col gap-4 border-b border-slate-200 dark:border-slate-700 pb-4">
                                            <div>
                                                <h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center">
                                                    <Icons.Database className="mr-3 text-indigo-500"/>Gestor de Extratos
                                                </h2>
                                                <p className="text-slate-500 dark:text-slate-400 mt-1">Navegue pelos arquivos salvos.</p>
                                            </div>
                                            <div className="flex gap-2">
                                                <div className="relative flex-1">
                                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                                        <Icons.Search size={18} />
                                                    </div>
                                                    <input type="text" placeholder="Pesquisar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-slate-200 rounded-lg pl-10 pr-4 py-2 outline-none focus:border-blue-500" />
                                                    {searchTerm && (
                                                        <button onClick={() => setSearchTerm('')} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600 dark:hover:text-white">
                                                            <Icons.X size={16} />
                                                        </button>
                                                    )}
                                                </div>
                                                {currentPath.length > 0 && !searchTerm && (
                                                    <button onClick={() => setCurrentPath(currentPath.slice(0, -1))} className="bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-white px-4 rounded-lg">
                                                        <Icons.ArrowLeft size={18} />
                                                    </button>
                                                )}
                                            </div>
                                        </header>
                                        {!searchTerm && (
                                            <div className="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800 p-3 rounded-lg mb-6 border border-slate-200 dark:border-slate-700 overflow-x-auto whitespace-nowrap">
                                                <button onClick={() => setCurrentPath([])} className="hover:text-blue-600 dark:hover:text-blue-400 flex items-center">
                                                    <Icons.Home size={14} className="mr-1"/> Raiz
                                                </button>
                                                {currentPath.map((folder, index) => (
                                                    <React.Fragment key={index}>
                                                        <Icons.ChevronRight size={14} />
                                                        <button onClick={() => { setCurrentPath(currentPath.slice(0, index + 1)); setSearchTerm(''); }} className="hover:text-blue-600 dark:hover:text-blue-400 font-medium">
                                                            {folder}
                                                        </button>
                                                    </React.Fragment>
                                                ))}
                                            </div>
                                        )}
                                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                            {getItemsAtCurrentPath().filter(Boolean).map((item, idx) => (
                                                <div key={idx} onClick={() => handleNavigate(item)} className={`p-4 rounded-xl border cursor-pointer flex flex-col items-center text-center space-y-3 transition-colors ${item.type === 'folder' ? 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700' : 'bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 hover:border-emerald-500/50 hover:bg-white dark:hover:bg-slate-800'}`}>
                                                    <div className={`p-3 rounded-full ${item.type === 'folder' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' : 'bg-slate-100 dark:bg-slate-700 ' + getFileColorClass(item?.fileName)}`}>
                                                        {item.type === 'folder' ? <Icons.Folder size={32} /> : (item?.fileName?.endsWith('pdf') ? <Icons.FileText size={32} /> : <Icons.FileSpreadsheet size={32} />)}
                                                    </div>
                                                    <div className="w-full">
                                                        <p className="text-sm font-medium text-slate-800 dark:text-slate-200 truncate">{item?.name || '-'}</p>
                                                    </div>
                                                </div>
                                            ))}
                                            {getItemsAtCurrentPath().length === 0 && (
                                                <div className="col-span-full py-12 text-center text-slate-500 font-medium">
                                                    Pasta Vazia ou Sem Resultados.
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </main>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <GestorComissoesApp />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
