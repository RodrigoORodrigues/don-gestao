<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Gestão - Don Gestão (Cloud)</title>
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: { extend: { colors: { slate: { 750: '#2d3748' } } } }
        }
    </script>

    <!-- Bibliotecas Essenciais -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Supabase SDK e Outras Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; } 
        .dark ::-webkit-scrollbar-track { background: #0f172a; } 
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 h-screen overflow-hidden selection:bg-blue-500 selection:text-white transition-colors duration-200">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        // Configuração do PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const { useState, useEffect, useRef } = React;
        
        // ============================================================================
        // 1. CONFIGURAÇÃO DO SUPABASE (A NOVA BASE DE DADOS CLOUD)
        // ============================================================================
        
        const SUPABASE_URL = 'https://ivyujdcwvbjoaqpzvuyv.supabase.co';
        // CORREÇÃO: A chave deve estar sempre entre aspas simples (' ')
        const SUPABASE_KEY = 'sb_publishable_KVZzm404mrwKsWyuqaeCNg_3nUoz84N';

        // Evita que a app quebre se as chaves ainda não tiverem sido configuradas corretamente
        const isSupabaseConfigured = SUPABASE_URL.startsWith('http') && SUPABASE_KEY !== 'COLE_AQUI_A_SUA_CHAVE_ANON';
        const supabase = isSupabaseConfigured ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

        // ============================================================================

        const SYSTEM_MODULES = [
            { id: 'dashboard', label: 'Visão Geral (Dashboard)' },
            { id: 'vendas', label: 'Vendas de Serviços' },
            { id: 'clientes', label: 'Gestão de Clientes' },
            { id: 'processar', label: 'Relatórios de Comissão (Processamento)' },
            { id: 'historico', label: 'Histórico de Relatórios Salvos' },
            { id: 'gestor', label: 'Gestor de Extratos (Arquivos Internos)' },
            { id: 'usuarios', label: 'Controle de Acessos e Permissões' },
            { id: 'settings', label: 'Configurações do Sistema e Backups' }
        ];

        // --- 2. SISTEMA DE ÍCONES (Lucide) ---
        const toPascalCase = (str) => str.replace(/(^\w|-\w)/g, (clear) => clear.replace(/-/, "").toUpperCase());
        const IconWrapper = ({ icon, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[toPascalCase(icon)]) {
                    const svg = lucide.createElement(lucide.icons[toPascalCase(icon)]);
                    svg.setAttribute('width', size); svg.setAttribute('height', size);
                    svg.setAttribute('class', `lucide lucide-${icon} ${className}`);
                    ref.current.innerHTML = ''; ref.current.appendChild(svg);
                }
            }, [icon, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center' }} />;
        };

        const Icons = {
            Folder: (p) => <IconWrapper icon="folder" {...p} />,
            FileText: (p) => <IconWrapper icon="file-text" {...p} />,
            Plus: (p) => <IconWrapper icon="plus" {...p} />,
            Home: (p) => <IconWrapper icon="home" {...p} />,
            ChevronRight: (p) => <IconWrapper icon="chevron-right" {...p} />,
            ChevronDown: (p) => <IconWrapper icon="chevron-down" {...p} />,
            Save: (p) => <IconWrapper icon="save" {...p} />,
            ArrowLeft: (p) => <IconWrapper icon="arrow-left" {...p} />,
            Building2: (p) => <IconWrapper icon="building-2" {...p} />,
            FolderTree: (p) => <IconWrapper icon="folder-tree" {...p} />,
            FileSpreadsheet: (p) => <IconWrapper icon="file-spreadsheet" {...p} />,
            Download: (p) => <IconWrapper icon="download" {...p} />,
            X: (p) => <IconWrapper icon="x" {...p} />,
            Search: (p) => <IconWrapper icon="search" {...p} />,
            Eye: (p) => <IconWrapper icon="eye" {...p} />,
            EyeOff: (p) => <IconWrapper icon="eye-off" {...p} />,
            Layers: (p) => <IconWrapper icon="layers" {...p} />,
            Settings: (p) => <IconWrapper icon="settings" {...p} />,
            Database: (p) => <IconWrapper icon="database" {...p} />,
            RefreshCw: (p) => <IconWrapper icon="refresh-cw" {...p} />,
            Trash2: (p) => <IconWrapper icon="trash-2" {...p} />,
            HardDrive: (p) => <IconWrapper icon="hard-drive" {...p} />,
            Users: (p) => <IconWrapper icon="users" {...p} />,
            FileCheck: (p) => <IconWrapper icon="file-check-2" {...p} />,
            CheckCircle: (p) => <IconWrapper icon="check-circle-2" {...p} />,
            XCircle: (p) => <IconWrapper icon="x-circle" {...p} />,
            Edit: (p) => <IconWrapper icon="edit" {...p} />,
            ListFilter: (p) => <IconWrapper icon="list-filter" {...p} />,
            Upload: (p) => <IconWrapper icon="upload" {...p} />,
            Sun: (p) => <IconWrapper icon="sun" {...p} />,
            Moon: (p) => <IconWrapper icon="moon" {...p} />,
            Printer: (p) => <IconWrapper icon="printer" {...p} />,
            Archive: (p) => <IconWrapper icon="archive" {...p} />,
            History: (p) => <IconWrapper icon="history" {...p} />,
            AlertCircle: (p) => <IconWrapper icon="alert-circle" {...p} />,
            Lock: (p) => <IconWrapper icon="lock" {...p} />,
            User: (p) => <IconWrapper icon="user" {...p} />,
            Key: (p) => <IconWrapper icon="key" {...p} />,
            LogOut: (p) => <IconWrapper icon="log-out" {...p} />,
            Shield: (p) => <IconWrapper icon="shield" {...p} />,
            ShoppingCart: (p) => <IconWrapper icon="shopping-cart" {...p} />,
        };

        const EMPRESAS_INTERNAS = ["Proper", "Protetta"];
        const CATEGORIAS = ["Operadoras", "Seguradoras"];
        const MESES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const dataDeHojeInterna = () => new Date().toISOString().split('T')[0];
        const formatarMoeda = (valor) => valor.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatarDataVisivel = (dataString) => {
            if(!dataString) return '--/--/----';
            const partes = dataString.split('-');
            return partes.length === 3 ? `${partes[2]}/${partes[1]}/${partes[0]}` : dataString;
        };

        const SidebarItem = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${active ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white'}`}>
                <Icon size={20} /><span className="font-medium text-sm">{label}</span>
            </button>
        );

        function GestorComissoesApp() {
            // TEMA
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('protetta_theme');
                return saved ? saved === 'dark' : true; 
            });

            // AUTENTICAÇÃO
            const [currentUser, setCurrentUser] = useState(() => {
                const saved = localStorage.getItem('protetta_auth_user');
                return saved ? JSON.parse(saved) : null;
            });
            const [loginData, setLoginData] = useState({ user: '', password: '' });
            const [loginError, setLoginError] = useState('');
            const [showPassword, setShowPassword] = useState(false);

            const hasAccess = (module) => {
                if (!currentUser) return false;
                if (currentUser.role === 'admin') return true; 
                return (currentUser.permissions || []).includes(module);
            };

            // SISTEMA DE ALERTAS
            const [alertDialog, setAlertDialog] = useState({ isOpen: false, message: '' });
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, message: '', onConfirm: null });

            const showAlert = (msg) => setAlertDialog({ isOpen: true, message: msg });
            const showConfirm = (msg, callback) => setConfirmDialog({ isOpen: true, message: msg, onConfirm: callback });

            const [currentView, setCurrentView] = useState('dashboard'); 
            const [loading, setLoading] = useState(false);
            const [loadingMsg, setLoadingMsg] = useState('');

            // ESTADOS 
            const [dbReports, setDbReports] = useState([]);
            const [currentPath, setCurrentPath] = useState([]); 
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedFile, setSelectedFile] = useState(null);

            const [clientes, setClientes] = useState([]);
            const [filtroNomeCliente, setFiltroNomeCliente] = useState('');
            const [showColMenu, setShowColMenu] = useState(false);
            const [cols, setCols] = useState({ codigo: false, nome: true, tipo: true, documento: true, telefone: true, celular: true, email: true, situacao: true, cadastrado_em: true, acoes: true });

            const [modalClienteOpen, setModalClienteOpen] = useState(false);
            const [modalBuscaOpen, setModalBuscaOpen] = useState(false);
            const [clienteEditIndex, setClienteEditIndex] = useState(-1);
            const [clienteForm, setClienteForm] = useState({ id: null, nome: '', tipo: 'Pessoa jurídica', documento: '', telefone: '', celular: '', email: '', situacao: true });
            
            const [modalArquivosOpen, setModalArquivosOpen] = useState(false);
            const [modalPrintOpen, setModalPrintOpen] = useState(false);
            const [printConfig, setPrintConfig] = useState({ orientation: 'landscape', scale: 100 });

            const [pdfData, setPdfData] = useState([]);
            const tabelaPdfRef = useRef(null);
            const [editRowIndex, setEditRowIndex] = useState(-1);
            const [editRowData, setEditRowData] = useState({});

            const [savedReportsList, setSavedReportsList] = useState([]);
            const [currentReportId, setCurrentReportId] = useState(null);
            const [reportName, setReportName] = useState('');
            const [reportPeriod, setReportPeriod] = useState('');

            const [usersList, setUsersList] = useState([]);
            const [modalUserOpen, setModalUserOpen] = useState(false);
            const [userForm, setUserForm] = useState({ id: null, username: '', password: '', role: 'user', permissions: [] });

            const [vendasList, setVendasList] = useState([]);
            const [showVendasFilter, setShowVendasFilter] = useState(true);
            const [showVendasPeriodMenu, setShowVendasPeriodMenu] = useState(false);
            const [vendasPeriodLabel, setVendasPeriodLabel] = useState('Todo o período');

            const [modalVendaOpen, setModalVendaOpen] = useState(false);
            const [vendaForm, setVendaForm] = useState({ id: null, numero: '', cliente: '', dataVenda: dataDeHojeInterna(), situacao: 'FATURADO PROTETTA NF', loja: 'PROTETTA SEGUROS', valor: 0, contrato: '', codigoOperadora: '', vidas: '', vitalicio: 'Selecione', parcela: '', inicioVigencia: '', notaFiscal: '', corretor: 'Corretor Interno' });

            const defaultVendasFilters = { loja: 'Todos', codigo: '', dataInicio: '', dataFim: '', situacao: 'Todos', cliente: '', contrato: '', codigoOperadora: '', vidas: '', vitalicio: 'Selecione', parcela: '', inicioVigencia: '', notaFiscal: '', corretor: 'Todos' };
            const [vendasFilterForm, setVendasFilterForm] = useState(defaultVendasFilters);
            const [appliedVendasFilters, setAppliedVendasFilters] = useState(null);

            // CARREGAMENTO DE DADOS DO SUPABASE
            const loadFromDB = async () => {
                if(!supabase) return;
                try {
                    const [resUsers, resCli, resVendas, resSaved, resRep] = await Promise.all([
                        supabase.from('users').select('*'),
                        supabase.from('clientes').select('*'),
                        supabase.from('vendas').select('*'),
                        supabase.from('savedReports').select('*'),
                        supabase.from('reports').select('*')
                    ]);
                    
                    if (resUsers.data) setUsersList(resUsers.data);
                    if (resCli.data) setClientes(resCli.data);
                    if (resVendas.data) setVendasList(resVendas.data);
                    if (resSaved.data) setSavedReportsList(resSaved.data);
                    if (resRep.data) setDbReports(resRep.data);

                } catch (err) { console.error("Erro ao carregar Supabase:", err); }
            };

            // Setup Inicial do Admin
            useEffect(() => {
                const initAdminSupabase = async () => {
                    if(!supabase) return;
                    try {
                        const { data } = await supabase.from('users').select('*').limit(1);
                        if (data && data.length === 0) {
                            await supabase.from('users').insert([{
                                username: 'admin', password: 'admin', role: 'admin', permissions: SYSTEM_MODULES.map(m => m.id)
                            }]);
                        }
                    } catch(e) {}
                };
                initAdminSupabase();
            }, []);

            useEffect(() => { if(currentUser) loadFromDB(); }, [currentUser]);
            
            useEffect(() => {
                if (isDarkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('protetta_theme', 'dark'); } 
                else { document.documentElement.classList.remove('dark'); localStorage.setItem('protetta_theme', 'light'); }
            }, [isDarkMode]);

            // --- LOGIN / LOGOUT ---
            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true); setLoadingMsg("Autenticando...");
                try {
                    const { data: users, error } = await supabase.from('users').select('*').eq('username', loginData.user);
                    
                    if (users && users.length > 0 && users[0].password === loginData.password) {
                        const user = users[0];
                        const sessionUser = { id: user.id, username: user.username, role: user.role, permissions: user.permissions || [] };
                        setCurrentUser(sessionUser);
                        localStorage.setItem('protetta_auth_user', JSON.stringify(sessionUser));
                        setLoginError('');
                        setLoginData({ user: '', password: '' });
                        setShowPassword(false);
                        
                        if (user.role !== 'admin' && !user.permissions.includes('dashboard')) {
                            if (user.permissions.length > 0) setCurrentView(user.permissions[0]);
                        } else {
                            setCurrentView('dashboard');
                        }
                    } else {
                        setLoginError('Credenciais inválidas ou erro ao ligar à Base de Dados. Verifique a chave Anon.');
                    }
                } catch(err) { setLoginError('Erro de conexão ao servidor Supabase.'); }
                finally { setLoading(false); }
            };

            const handleLogout = () => {
                showConfirm("Tem a certeza que deseja terminar a sessão?", () => {
                    setCurrentUser(null);
                    localStorage.removeItem('protetta_auth_user');
                    setCurrentView('dashboard');
                });
            };

            // Se o Supabase não estiver configurado, mostra um ecrã de bloqueio elegante
            if (!isSupabaseConfigured) {
                return (
                    <div className="flex h-screen w-screen items-center justify-center bg-slate-900 p-6">
                        <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full text-center border border-slate-700">
                            <Icons.Database size={48} className="text-blue-500 mx-auto mb-4" />
                            <h1 className="text-2xl font-bold text-white mb-2">Conexão Cloud Necessária</h1>
                            <p className="text-slate-400 mb-6 text-sm">O seu sistema Don Gestão foi atualizado para uma arquitetura cloud com o Supabase. Para continuar, por favor abra o código fonte e preencha as variáveis <strong>SUPABASE_URL</strong> e <strong>SUPABASE_KEY</strong> na linha 49.</p>
                            <div className="bg-slate-900 p-4 rounded-lg text-left text-xs font-mono text-emerald-400 border border-slate-700">
                                const SUPABASE_URL = 'https://ivyujdcwvbjoaqpzvuyv.supabase.co';<br/>
                                const SUPABASE_KEY = 'SUA_CHAVE_GIGANTE_AQUI';
                            </div>
                        </div>
                    </div>
                );
            }

            // --- RENDERIZAÇÃO: TELA DE LOGIN ---
            if (!currentUser) {
                return (
                    <div className="flex h-screen w-screen items-center justify-center bg-slate-100 dark:bg-slate-900 transition-colors duration-200 p-4">
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-200 dark:border-slate-700 transition-colors relative">
                            <div className="flex flex-col items-center mb-8">
                                <div className="bg-emerald-600 p-3 rounded-xl font-bold text-white text-3xl leading-none border border-emerald-400/50 mb-4 shadow-lg">D</div>
                                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">Don Gestão</h1>
                                <p className="text-slate-500 dark:text-slate-400 text-sm mt-1">Acesso ao Sistema de Gestão</p>
                            </div>
                            
                            <form onSubmit={handleLogin} className="space-y-5">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Utilizador</label>
                                    <div className="relative">
                                        <Icons.User size={18} className="absolute left-3 top-3 text-slate-400" />
                                        <input type="text" required value={loginData.user} onChange={e => setLoginData({...loginData, user: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg pl-10 pr-4 py-2.5 text-slate-900 dark:text-white outline-none focus:border-emerald-500 transition-colors" placeholder="Digite o seu utilizador" />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Palavra-passe</label>
                                    <div className="relative">
                                        <Icons.Key size={18} className="absolute left-3 top-3 text-slate-400" />
                                        <input type={showPassword ? "text" : "password"} required value={loginData.password} onChange={e => setLoginData({...loginData, password: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg pl-10 pr-10 py-2.5 text-slate-900 dark:text-white outline-none focus:border-emerald-500 transition-colors" placeholder="••••••••" />
                                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors focus:outline-none" title={showPassword ? "Ocultar senha" : "Mostrar senha"}>
                                            {showPassword ? <Icons.EyeOff size={18} /> : <Icons.Eye size={18} />}
                                        </button>
                                    </div>
                                </div>
                                
                                {loginError && <p className="text-rose-500 dark:text-rose-400 text-sm font-bold text-center bg-rose-100 dark:bg-rose-500/10 py-2 rounded-lg border border-rose-200 dark:border-rose-500/20">{loginError}</p>}
                                
                                <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2 transition-colors shadow-lg mt-4 disabled:opacity-50" disabled={loading}>
                                    {loading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <><Icons.Lock size={18} /><span>Entrar no Sistema</span></>}
                                </button>
                            </form>
                        </div>
                        
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="absolute bottom-6 right-6 p-3 bg-white dark:bg-slate-800 rounded-full shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:text-emerald-500 dark:hover:text-emerald-400 transition-colors">
                            {isDarkMode ? <Icons.Sun size={20} /> : <Icons.Moon size={20} />}
                        </button>
                    </div>
                );
            }

            // --- LÓGICA DE VENDAS E FILTRAGEM UNIFICADA ---
            const applyDatePreset = (preset) => {
                let start = '';
                let end = '';
                const today = new Date();
                
                const formatDate = (date) => {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                };

                switch(preset) {
                    case 'Hoje':
                        start = formatDate(today); end = formatDate(today); break;
                    case 'Esta semana':
                        const first = today.getDate() - today.getDay();
                        start = formatDate(new Date(today.getFullYear(), today.getMonth(), first));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth(), first + 6));
                        break;
                    case 'Mês passado':
                        start = formatDate(new Date(today.getFullYear(), today.getMonth() - 1, 1));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth(), 0));
                        break;
                    case 'Este mês':
                        start = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                        break;
                    case 'Próximo mês':
                        start = formatDate(new Date(today.getFullYear(), today.getMonth() + 1, 1));
                        end = formatDate(new Date(today.getFullYear(), today.getMonth() + 2, 0));
                        break;
                    case 'Todo o período':
                    default:
                        start = ''; end = ''; break;
                }

                setVendasPeriodLabel(preset);
                setShowVendasPeriodMenu(false);
                
                if (preset === 'Escolha o período') {
                    setShowVendasFilter(true); 
                } else {
                    const updatedFilters = { ...vendasFilterForm, dataInicio: start, dataFim: end };
                    setVendasFilterForm(updatedFilters);
                    setAppliedVendasFilters(updatedFilters);
                }
            };

            const handleBuscarVendas = () => { setAppliedVendasFilters({ ...vendasFilterForm }); };

            const handleLimparVendas = () => {
                setVendasFilterForm(defaultVendasFilters);
                setAppliedVendasFilters(null);
                setVendasPeriodLabel('Todo o período');
            };

            const getFilteredVendas = () => {
                let todasAsVendas = [...vendasList];
                
                savedReportsList.forEach(report => {
                    if (report.dados && Array.isArray(report.dados)) {
                        report.dados.forEach((dado, idx) => {
                            todasAsVendas.push({
                                id: `rep_${report.id}_${idx}`, 
                                isFromReport: true,
                                reportId: report.id,
                                reportRowIndex: idx,
                                numero: dado.cod,
                                cliente: dado.cliente,
                                dataVenda: report.dataCriacao ? report.dataCriacao.split('T')[0] : dataDeHojeInterna(),
                                situacao: dado.situacao,
                                loja: dado.loja,
                                valor: dado.valorTotal,
                                contrato: '', codigoOperadora: '', vidas: '', vitalicio: '', parcela: '', inicioVigencia: '', notaFiscal: '', corretor: ''
                            });
                        });
                    }
                });

                if (appliedVendasFilters) {
                    const f = appliedVendasFilters;
                    if (f.loja !== 'Todos') todasAsVendas = todasAsVendas.filter(v => v.loja === f.loja);
                    if (f.situacao !== 'Todos') todasAsVendas = todasAsVendas.filter(v => v.situacao === f.situacao);
                    if (f.codigo) todasAsVendas = todasAsVendas.filter(v => (v.numero || '').toLowerCase().includes(f.codigo.toLowerCase()));
                    if (f.cliente) todasAsVendas = todasAsVendas.filter(v => (v.cliente || '').toLowerCase().includes(f.cliente.toLowerCase()));
                    if (f.contrato) todasAsVendas = todasAsVendas.filter(v => (v.contrato || '').toLowerCase().includes(f.contrato.toLowerCase()));
                    if (f.codigoOperadora) todasAsVendas = todasAsVendas.filter(v => (v.codigoOperadora || '').toLowerCase().includes(f.codigoOperadora.toLowerCase()));
                    if (f.notaFiscal) todasAsVendas = todasAsVendas.filter(v => (v.notaFiscal || '').toLowerCase().includes(f.notaFiscal.toLowerCase()));
                    if (f.vidas) todasAsVendas = todasAsVendas.filter(v => v.vidas == f.vidas);
                    if (f.vitalicio !== 'Selecione') todasAsVendas = todasAsVendas.filter(v => v.vitalicio === f.vitalicio);
                    if (f.corretor !== 'Todos') todasAsVendas = todasAsVendas.filter(v => v.corretor === f.corretor);
                    if (f.dataInicio) todasAsVendas = todasAsVendas.filter(v => v.dataVenda >= f.dataInicio);
                    if (f.dataFim) todasAsVendas = todasAsVendas.filter(v => v.dataVenda <= f.dataFim);
                }
                
                todasAsVendas.sort((a, b) => new Date(b.dataVenda) - new Date(a.dataVenda));
                return todasAsVendas;
            };

            const displayedVendas = getFilteredVendas();

            let displayPeriodLabel = vendasPeriodLabel;
            if (vendasPeriodLabel === 'Escolha o período' && appliedVendasFilters?.dataInicio && appliedVendasFilters?.dataFim) {
                 displayPeriodLabel = `${formatarDataVisivel(appliedVendasFilters.dataInicio)} - ${formatarDataVisivel(appliedVendasFilters.dataFim)}`;
            } else if (vendasPeriodLabel === 'Escolha o período') {
                 displayPeriodLabel = 'Período Customizado';
            }

            const getSituacaoColor = (situacao) => {
                if (!situacao) return 'bg-slate-100 text-slate-700';
                if (situacao.includes('FATURADO')) return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-400';
                if (situacao.includes('PENDENTE')) return 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400';
                if (situacao.includes('CANCELADO')) return 'bg-rose-100 text-rose-700 dark:bg-rose-500/20 dark:text-rose-400';
                return 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300';
            };

            const abrirModalVenda = (venda = null) => {
                if (venda) setVendaForm({ ...venda });
                else setVendaForm({ id: null, numero: Math.floor(10000 + Math.random() * 90000).toString(), cliente: '', dataVenda: dataDeHojeInterna(), situacao: 'FATURADO PROTETTA NF', loja: 'PROTETTA SEGUROS', valor: 0, contrato: '', codigoOperadora: '', vidas: '', vitalicio: 'Selecione', parcela: '', inicioVigencia: '', notaFiscal: '', corretor: 'Corretor Interno' });
                setModalVendaOpen(true);
            };

            const salvarVenda = async (e) => {
                e.preventDefault();
                setLoading(true); setLoadingMsg("Guardando venda...");
                try {
                    const dataToSave = { ...vendaForm, valor: parseFloat(vendaForm.valor) || 0 };

                    if (vendaForm.isFromReport) {
                        const rep = await supabase.from('savedReports').select('*').eq('id', vendaForm.reportId).single();
                        if (rep.data) {
                            let dadosAtualizados = [...rep.data.dados];
                            dadosAtualizados[vendaForm.reportRowIndex] = {
                                ...dadosAtualizados[vendaForm.reportRowIndex],
                                cod: dataToSave.numero, cliente: dataToSave.cliente, situacao: dataToSave.situacao,
                                loja: dataToSave.loja, valorTotal: dataToSave.valor
                            };
                            await supabase.from('savedReports').update({ dados: dadosAtualizados }).eq('id', rep.data.id);
                        }
                    } else if (vendaForm.id) {
                        await supabase.from('vendas').update(dataToSave).eq('id', vendaForm.id);
                    } else {
                        delete dataToSave.id;
                        await supabase.from('vendas').insert([dataToSave]);
                    }
                    
                    await loadFromDB();
                    setModalVendaOpen(false);
                    showAlert("Venda guardada com sucesso!");
                } catch (err) { showAlert("Erro ao guardar: " + err.message); } finally { setLoading(false); }
            };

            const apagarVenda = (venda) => {
                showConfirm(`Tem a certeza que deseja apagar permanentemente este registo?`, async () => {
                    setLoading(true); setLoadingMsg("Apagando...");
                    if (venda.isFromReport) {
                        const rep = await supabase.from('savedReports').select('*').eq('id', venda.reportId).single();
                        if (rep.data) {
                            let dados = rep.data.dados.filter((_, idx) => idx !== venda.reportRowIndex);
                            await supabase.from('savedReports').update({ dados: dados }).eq('id', rep.data.id);
                        }
                    } else {
                        await supabase.from('vendas').delete().eq('id', venda.id);
                    }
                    await loadFromDB();
                    setLoading(false);
                });
            };

            // --- FUNÇÕES DE USUÁRIOS (CONTROLE DE ACESSOS CLOUD) ---
            const abrirModalUsuario = (user = null) => {
                if (user) setUserForm({ ...user });
                else setUserForm({ id: null, username: '', password: '', role: 'user', permissions: [] });
                setModalUserOpen(true);
            };

            const salvarUsuario = async (e) => {
                e.preventDefault();
                setLoading(true); setLoadingMsg("Guardando utilizador...");
                try {
                    const { data: existing } = await supabase.from('users').select('*').eq('username', userForm.username);
                    if (existing && existing.length > 0 && existing[0].id !== userForm.id) {
                        setLoading(false); return showAlert("Já existe um utilizador registado com este nome.");
                    }
                    
                    const dataToSave = {
                        username: userForm.username, password: userForm.password, role: userForm.role,
                        permissions: userForm.role === 'admin' ? SYSTEM_MODULES.map(m=>m.id) : userForm.permissions
                    };

                    if (userForm.id) {
                        await supabase.from('users').update(dataToSave).eq('id', userForm.id);
                        if (currentUser?.id === userForm.id) {
                            const updatedSession = { ...currentUser, ...dataToSave };
                            setCurrentUser(updatedSession);
                            localStorage.setItem('protetta_auth_user', JSON.stringify(updatedSession));
                        }
                    } else { await supabase.from('users').insert([dataToSave]); }
                    
                    await loadFromDB(); setModalUserOpen(false); showAlert("Utilizador guardado com sucesso!");
                } catch (err) { showAlert("Erro ao guardar: " + err.message); } finally { setLoading(false); }
            };

            const apagarUsuario = (u) => {
                if (u.username === 'admin') return showAlert("Proteção de Sistema: Não é possível apagar a conta padrão (admin).");
                if (currentUser?.id === u.id) return showAlert("Você não pode apagar a sua própria conta enquanto estiver conectado.");
                showConfirm(`Tem a certeza que deseja apagar permanentemente o utilizador '${u.username}'?`, async () => {
                    await supabase.from('users').delete().eq('id', u.id); await loadFromDB();
                });
            };

            // --- FUNÇÕES: GESTOR DE EXTRATOS (STORAGE CLOUD) ---
            const [formData, setFormData] = useState({ ano: new Date().getFullYear().toString(), mes: MESES[0], categoria: CATEGORIAS[0], empresa: EMPRESAS_INTERNAS[0], parceiro: '', arquivos: [] });
            const [formError, setFormError] = useState('');
            const [successMsg, setSuccessMsg] = useState('');
            const fileInputRef = useRef(null);

            const getFileColorClass = (fileName) => {
                if (!fileName) return "text-slate-400 dark:text-slate-300";
                const ext = fileName.split('.').pop().toLowerCase();
                if (['csv', 'xlsx', 'xls'].includes(ext)) return "text-emerald-600 dark:text-emerald-400";
                if (['pdf'].includes(ext)) return "text-rose-600 dark:text-rose-400";
                return "text-slate-400 dark:text-slate-300";
            };

            const getItemsAtCurrentPath = () => {
                if (searchTerm.trim() !== '') {
                    const term = searchTerm.toLowerCase();
                    return dbReports.filter(r => r.parceiro.toLowerCase().includes(term) || r.fileName.toLowerCase().includes(term) || r.empresa.toLowerCase().includes(term))
                                    .map(f => ({ ...f, type: 'file', pathInfo: `${f.ano} / ${f.mes} / ${f.empresa}` }));
                }
                if (currentPath.length === 0) return [...new Set(dbReports.map(r => r.ano))].sort().map(y => ({ id: y, name: y, type: 'folder' }));
                if (currentPath.length === 1) return [...new Set(dbReports.filter(r => r.ano === currentPath[0]).map(r => r.mes))].sort((a, b) => MESES.indexOf(a) - MESES.indexOf(b)).map(m => ({ id: m, name: m, type: 'folder' }));
                if (currentPath.length === 2) return CATEGORIAS.map(c => ({ id: c, name: c, type: 'folder' }));
                if (currentPath.length === 3) return EMPRESAS_INTERNAS.map(e => ({ id: e, name: e, type: 'folder' }));
                if (currentPath.length === 4) return dbReports.filter(r => r.ano === currentPath[0] && r.mes === currentPath[1] && r.categoria === currentPath[2] && r.empresa === currentPath[3]).map(f => ({ ...f, type: 'file', name: f.parceiro }));
                return [];
            };

            const handleSubmitExtrato = async (e) => {
                e.preventDefault();
                if (!formData.parceiro.trim()) return setFormError('ERRO: Parceiro obrigatório.');
                if (formData.arquivos.length === 0) return setFormError('ERRO: Anexos obrigatórios.');
                setLoading(true); setLoadingMsg("Fazendo upload para a nuvem...");
                try {
                    for (const file of formData.arquivos) {
                        const filePath = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                        
                        const { data: uploadData, error: uploadErr } = await supabase.storage
                            .from('arquivos_extratos')
                            .upload(filePath, file);

                        if(uploadErr) throw uploadErr;

                        await supabase.from('reports').insert([{ 
                            ano: formData.ano, mes: formData.mes, categoria: formData.categoria, 
                            empresa: formData.empresa, parceiro: formData.parceiro, 
                            date: new Date().toISOString(), fileName: file.name, filePath: filePath 
                        }]);
                    }
                    
                    await loadFromDB();
                    setSuccessMsg(`${formData.arquivos.length} extratos guardados!`);
                    setFormData(prev => ({ ...prev, parceiro: '', arquivos: [] }));
                    setTimeout(() => setSuccessMsg(''), 4000);
                } catch (error) { showAlert("Erro ao enviar ficheiro para a Cloud: " + error.message); } 
                finally { setLoading(false); }
            };

            const handleNavigate = async (item) => {
                if (item.type === 'folder') { setCurrentPath([...currentPath, item.name]); setSearchTerm(''); } 
                else if (item.type === 'file') {
                    setLoading(true); setLoadingMsg("Descarregando ficheiro...");
                    try { 
                        const { data, error } = await supabase.storage.from('arquivos_extratos').download(item.filePath);
                        if(error) throw error;
                        setSelectedFile({ ...item, fileObj: data }); 
                    } 
                    catch(e) { showAlert("Erro ao descarregar da Cloud: " + e.message); }
                    finally { setLoading(false); }
                }
            };

            // --- FUNÇÕES: CLIENTES CLOUD ---
            const clientesFiltrados = clientes.filter(cli => cli.nome.toLowerCase().includes(filtroNomeCliente.toLowerCase()));

            const apagarCliente = (id) => {
                showConfirm("Tem a certeza que deseja apagar este cliente?", async () => {
                    setLoading(true); setLoadingMsg("Apagando cliente...");
                    await supabase.from('clientes').delete().eq('id', id);
                    await loadFromDB(); setLoading(false);
                });
            };

            const abrirModalAddEdit = (cliente = null) => {
                if (cliente) { setClienteForm({...cliente}); setClienteEditIndex(cliente.id); } 
                else { setClienteForm({ id: null, nome: '', tipo: 'Pessoa jurídica', documento: '', telefone: '', celular: '', email: '', situacao: true }); setClienteEditIndex(-1); }
                setModalClienteOpen(true);
            };

            const salvarCliente = async (e) => {
                e.preventDefault();
                setLoading(true); setLoadingMsg("Guardando cliente...");
                try {
                    const clienteParaSalvar = { ...clienteForm };
                    clienteParaSalvar.nome = clienteParaSalvar.nome.trim();

                    if (clienteEditIndex >= 0) {
                        const duplicado = clientes.find(c => c.id !== clienteEditIndex && c.nome.toLowerCase() === clienteParaSalvar.nome.toLowerCase());
                        if (duplicado) { setLoading(false); return showAlert("Já existe outro cliente registado com este nome exato."); }
                        
                        await supabase.from('clientes').update(clienteParaSalvar).eq('id', clienteEditIndex);
                    } else {
                        const duplicado = clientes.find(c => c.nome.toLowerCase() === clienteParaSalvar.nome.toLowerCase());
                        if (duplicado) { setLoading(false); return showAlert("Não é possível salvar. Já existe um cliente com este nome na base."); }
                        
                        clienteParaSalvar.codigo = Math.floor(10000 + Math.random() * 90000).toString();
                        clienteParaSalvar.cadastradoEm = dataDeHojeInterna();
                        delete clienteParaSalvar.id;
                        await supabase.from('clientes').insert([clienteParaSalvar]);
                    }
                    await loadFromDB(); setModalClienteOpen(false);
                } catch (err) { showAlert("Erro ao guardar cliente: " + err.message); }
                finally { setLoading(false); }
            };

            const importarClientes = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setLoading(true); setLoadingMsg("Lendo ficheiro e guardando na nuvem...");
                const ext = file.name.split('.').pop().toLowerCase();
                try {
                    let novosClientesParaInserir = [];
                    
                    if (ext === 'xlsx' || ext === 'csv') {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data);
                        const linhasExcel = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        
                        linhasExcel.forEach(linha => {
                            let nome = linha['Nome'] || linha['NOME'] || linha['Cliente'] || "Sem Nome";
                            nome = nome.trim();
                            if(!clientes.find(c => c.nome.toLowerCase() === nome.toLowerCase()) && !novosClientesParaInserir.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                                novosClientesParaInserir.push({
                                    codigo: Math.floor(10000 + Math.random() * 90000).toString(),
                                    nome: nome, tipo: linha['Tipo'] || 'Pessoa jurídica', documento: linha['Documento'] || linha['CNPJ'] || linha['NIF'] || '',
                                    telefone: linha['Telefone'] || '', celular: linha['Celular'] || '', email: linha['Email'] || linha['E-mail'] || '',
                                    situacao: true, cadastradoEm: dataDeHojeInterna() 
                                });
                            }
                        });
                    }

                    if(novosClientesParaInserir.length > 0){
                        await supabase.from('clientes').insert(novosClientesParaInserir);
                        await loadFromDB();
                        showAlert(`${novosClientesParaInserir.length} novos clientes importados com sucesso! (Duplicados ignorados)`);
                    } else {
                        showAlert("Nenhum cliente novo encontrado no ficheiro.");
                    }
                } catch (err) { showAlert("Erro ao importar: " + err.message); } 
                finally { setLoading(false); event.target.value = ''; }
            };

            // --- FUNÇÕES: PROCESSAR EXTRATO AMIL CLOUD ---
            const processarArquivoDoBanco = async (report) => {
                setLoading(true); setLoadingMsg("A descarregar PDF da nuvem...");
                setModalArquivosOpen(false); 
                try {
                    const { data: fileBlob, error } = await supabase.storage.from('arquivos_extratos').download(report.filePath);
                    if (error || !fileBlob) throw new Error("Ficheiro PDF não encontrado no Storage.");
                    
                    setLoadingMsg("A processar dados do PDF...");
                    const arrayBuffer = await fileBlob.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let textoCompleto = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        textoCompleto += textContent.items.map(item => item.str).join(" ") + " ";
                    }
                    await extrairDadosDoTexto(textoCompleto);
                } catch (error) { showAlert("Erro ao ler o PDF: " + error.message); } 
                finally { setLoading(false); }
            };

            const extrairDadosDoTexto = async (texto) => {
                setCurrentReportId(null); 
                setReportName(`Relatório Automático - ${new Date().toLocaleDateString('pt-PT')}`);
                setReportPeriod('');

                let textoNormalizado = texto.replace(/\s+/g, ' ').trim();
                let textoSemFalsoContrato = textoNormalizado.replace(/Total\s+contrato\s*:/gi, 'Total_Apurado:');
                const blocosContrato = textoSemFalsoContrato.split(/Contrato\s*:/i);
                if (blocosContrato.length > 0) blocosContrato.shift();

                const novosRegistos = [];
                const clientesParaInserir = [];
                const nomesClientesExistem = new Set(clientes.map(c => c.nome.toLowerCase()));

                for (let bloco of blocosContrato) {
                    try {
                        bloco = bloco.trim(); if (bloco === "") continue;
                        let codCliente = "N/D", nomeCliente = "";
                        
                        const matchNome = bloco.match(/^(\d+)\s*(?:-)?\s*(.+?)(?=\s+Fatura|\s+Proposta|\s+Data|\s+Qtd|\s+Forma|\s+\d{2}\/\d{4})/i);
                        if (matchNome) { 
                            codCliente = matchNome[1].trim(); 
                            nomeCliente = matchNome[2].trim(); 
                            nomeCliente = nomeCliente.replace(/(?:\s+[\d\/\.\-,]+)+$/, '').trim();
                        }
                        if(!nomeCliente) continue;

                        if(!nomesClientesExistem.has(nomeCliente.toLowerCase())) {
                            nomesClientesExistem.add(nomeCliente.toLowerCase());
                            clientesParaInserir.push({
                                codigo: codCliente, nome: nomeCliente, tipo: 'Pessoa jurídica', documento: codCliente, 
                                telefone: '', celular: '', email: '', situacao: true, cadastradoEm: dataDeHojeInterna() 
                            });
                        }

                        let valorTotal = 0, comissao = 0;
                        const regexValores = /Sem Repique\s+(\d{1,2},\d{2})\s+([\d\.]+,\d{2})\s+([\d\.]+,\d{2})/i;
                        let matchValores = regexValores.exec(bloco);
                        if (matchValores) {
                            valorTotal = parseFloat(matchValores[2].replace(/\./g, '').replace(',', '.'));
                            comissao = parseFloat(matchValores[3].replace(/\./g, '').replace(',', '.')); 
                        } else {
                            const regexFallback = /(\d{1,2},\d{2})\s+([\d\.]+,\d{2})\s+([\d\.]+,\d{2})\s+Médico/i;
                            let matchFallback = regexFallback.exec(bloco);
                            if(matchFallback){
                                valorTotal = parseFloat(matchFallback[2].replace(/\./g, '').replace(',', '.'));
                                comissao = parseFloat(matchFallback[3].replace(/\./g, '').replace(',', '.'));
                            }
                        }

                        if (valorTotal > 0) {
                            novosRegistos.push({ cod: codCliente, cliente: nomeCliente, data: "01/2026", situacao: "FATURADO PROTETTA NF", loja: "PROTETTA", valorTotal, comissao });
                        }
                    } catch (e) { console.warn("Erro bloco:", e); }
                }
                
                if(clientesParaInserir.length > 0) {
                    await supabase.from('clientes').insert(clientesParaInserir);
                    await loadFromDB();
                }
                setPdfData(novosRegistos);
                showAlert("Extrato processado com sucesso! Nomes limpos guardados.");
            };

            const startEditingRow = (idx, linha) => { setEditRowIndex(idx); setEditRowData({...linha}); };
            const saveRowEdit = () => {
                const newData = [...pdfData];
                newData[editRowIndex] = { ...editRowData, valorTotal: parseFloat(editRowData.valorTotal) || 0, comissao: parseFloat(editRowData.comissao) || 0 };
                setPdfData(newData); setEditRowIndex(-1);
            };
            const cancelRowEdit = () => setEditRowIndex(-1);
            const deleteRowFromReport = (idx) => {
                showConfirm("Deseja apagar esta linha do relatório?", () => {
                    setPdfData(prev => prev.filter((_, i) => i !== idx));
                    if (editRowIndex === idx) setEditRowIndex(-1);
                    else if (editRowIndex > idx) setEditRowIndex(editRowIndex - 1);
                });
            };
            const addManualRow = () => {
                const novaLinha = { cod: '', cliente: 'Novo Cliente', data: '', situacao: 'FATURADO PROTETTA NF', loja: 'PROTETTA', valorTotal: 0, comissao: 0 };
                const newData = [...pdfData, novaLinha];
                setPdfData(newData); setEditRowIndex(newData.length - 1); setEditRowData(novaLinha);
            };

            const salvarRelatorioComissao = async () => {
                if(!reportName) return showAlert('Digite um nome para o relatório antes de salvar.');
                if(pdfData.length === 0) return showAlert('Não há dados para salvar.');
                
                const dataToSave = { nome: reportName, periodo: reportPeriod, dataCriacao: new Date().toISOString(), dados: pdfData };
                setLoading(true); setLoadingMsg("Guardando relatório na cloud...");
                try {
                    if (currentReportId) await supabase.from('savedReports').update(dataToSave).eq('id', currentReportId);
                    else { 
                        const { data } = await supabase.from('savedReports').insert([dataToSave]).select(); 
                        if(data) setCurrentReportId(data[0].id); 
                    }
                    await loadFromDB(); setSuccessMsg("Relatório salvo com sucesso!");
                    setTimeout(() => setSuccessMsg(''), 3000);
                } catch(e) { showAlert('Erro ao salvar relatório: ' + e.message); } finally { setLoading(false); }
            };

            const carregarRelatorioSalvo = (report) => {
                setPdfData(report.dados || []); setReportName(report.nome); setReportPeriod(report.periodo || ''); setCurrentReportId(report.id); setCurrentView('processar');
            };

            const apagarRelatorioSalvo = (id) => {
                showConfirm("Tem certeza que deseja excluir permanentemente este relatório da nuvem?", async () => {
                    setLoading(true); setLoadingMsg("A apagar...");
                    await supabase.from('savedReports').delete().eq('id', id);
                    if(currentReportId === id) { setPdfData([]); setCurrentReportId(null); }
                    await loadFromDB();
                    setLoading(false);
                });
            };

            // --- IMPRESSÃO ---
            const handlePrintConfirm = () => {
                const printElement = document.getElementById('print-section');
                if (!printElement) return;

                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    showAlert("Aviso: O seu navegador bloqueou a janela de impressão. Por favor, permita pop-ups para conseguir imprimir.");
                    return;
                }

                const htmlContent = printElement.innerHTML;

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="pt-PT">
                    <head>
                        <title>Relatório de Comissão - Impressão</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>
                            @page { size: ${printConfig.orientation}; margin: 10mm; }
                            body { background-color: white !important; color: black !important; font-family: ui-sans-serif, system-ui, sans-serif; }
                            body::-webkit-scrollbar { display: none; }
                            #print-header { display: block !important; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
                            .print-wrapper { transform: scale(${printConfig.scale / 100}); transform-origin: top left; width: ${100 / (printConfig.scale / 100)}%; }
                            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                            th, td { border: 1px solid #94a3b8 !important; color: black !important; padding: 8px 12px; }
                            th { background-color: #f1f5f9 !important; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .text-slate-400, .text-slate-300, .text-slate-200, .text-slate-500, .text-emerald-400, .text-sky-400 { color: black !important; }
                            .no-print { display: none !important; }
                        </style>
                    </head>
                    <body class="p-8 bg-white">
                        <div class="print-wrapper">
                            ${htmlContent}
                        </div>
                        <script>
                            setTimeout(() => {
                                window.document.close();
                                window.focus();
                                window.print();
                            }, 800);
                        <\/script>
                    </body>
                    </html>
                `);
                setModalPrintOpen(false); 
            };

            // --- RENDERIZAÇÃO: SISTEMA PRINCIPAL (CONTINUAÇÃO UI) ---
            return (
                <div className="flex h-full bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans overflow-hidden transition-colors duration-200">
                    
                    {/* CUSTOM ALERT E CONFIRM MODAL */}
                    {alertDialog.isOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-slate-200 dark:border-slate-700">
                                <h3 className="text-lg font-bold mb-3 text-slate-900 dark:text-white flex items-center"><Icons.AlertCircle className="mr-2 text-blue-500"/> Aviso do Sistema</h3>
                                <p className="text-sm text-slate-700 dark:text-slate-300 mb-6 whitespace-pre-wrap">{alertDialog.message}</p>
                                <div className="flex justify-end"><button onClick={() => setAlertDialog({ isOpen: false, message: '' })} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition-colors">OK</button></div>
                            </div>
                        </div>
                    )}

                    {confirmDialog.isOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-slate-200 dark:border-slate-700">
                                <h3 className="text-lg font-bold mb-3 text-slate-900 dark:text-white flex items-center"><Icons.AlertCircle className="mr-2 text-amber-500"/> Confirmação Necessária</h3>
                                <p className="text-sm text-slate-700 dark:text-slate-300 mb-6 whitespace-pre-wrap">{confirmDialog.message}</p>
                                <div className="flex justify-end gap-3">
                                    <button onClick={() => setConfirmDialog({ isOpen: false, message: '', onConfirm: null })} className="bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Cancelar</button>
                                    <button onClick={() => { if(confirmDialog.onConfirm) confirmDialog.onConfirm(); setConfirmDialog({ isOpen: false, message: '', onConfirm: null }); }} className="bg-rose-600 hover:bg-rose-500 text-white px-6 py-2 rounded-lg font-bold transition-colors shadow-lg">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {loading && (
                        <div className="fixed inset-0 z-[60] bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center">
                            <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p className="text-slate-800 dark:text-white font-medium animate-pulse">{loadingMsg}</p>
                        </div>
                    )}

                    {/* SIDEBAR LATERAL */}
                    <aside className="w-64 bg-white dark:bg-slate-950 border-r border-slate-200 dark:border-slate-800 flex flex-col p-4 hidden md:flex shrink-0 transition-colors duration-200 z-10 relative">
                        <div className="flex items-center space-x-2 px-2 mb-8 mt-2">
                            <div className="bg-emerald-600 p-2 rounded-lg font-bold text-white leading-none border border-emerald-400/50">D</div>
                            <div>
                                <h1 className="text-lg font-bold text-slate-900 dark:text-white leading-tight">Don Gestão</h1>
                                <p className="text-xs text-slate-500 flex items-center mt-0.5">
                                    <Icons.User size={12} className="mr-1"/> {currentUser?.username}
                                </p>
                            </div>
                        </div>
                        
                        <nav className="flex-1 space-y-1 overflow-y-auto pr-2">
                            <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase px-4 pt-2 mb-2">Principal</p>
                            {hasAccess('dashboard') && <SidebarItem icon={Icons.Home} label="Dashboard" active={currentView === 'dashboard'} onClick={() => setCurrentView('dashboard')} />}
                            {hasAccess('vendas') && <SidebarItem icon={Icons.ShoppingCart} label="Vendas de Serviços" active={currentView === 'vendas'} onClick={() => setCurrentView('vendas')} />}
                            {hasAccess('clientes') && <SidebarItem icon={Icons.Users} label="Clientes" active={currentView === 'clientes'} onClick={() => setCurrentView('clientes')} />}
                            {hasAccess('processar') && <SidebarItem icon={Icons.FileCheck} label="Relatórios de Comissão" active={currentView === 'processar'} onClick={() => setCurrentView('processar')} />}
                            {hasAccess('historico') && <SidebarItem icon={Icons.History} label="Relatórios Salvos" active={currentView === 'historico'} onClick={() => setCurrentView('historico')} />}
                            
                            {hasAccess('gestor') && <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase px-4 pt-6 mb-2">Gestor de Extratos</p>}
                            {hasAccess('gestor') && <SidebarItem icon={Icons.Plus} label="Incluir Extrato" active={currentView === 'gestor-add'} onClick={() => { setCurrentView('gestor-add'); setSuccessMsg(''); }} />}
                            {hasAccess('gestor') && <SidebarItem icon={Icons.FolderTree} label="Consultar Extratos" active={currentView === 'gestor-browse'} onClick={() => { setCurrentPath([]); setCurrentView('gestor-browse'); setSearchTerm(''); }} />}
                            
                            {(hasAccess('settings') || hasAccess('usuarios')) && <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase px-4 pt-6 mb-2">Sistema</p>}
                            {hasAccess('usuarios') && <SidebarItem icon={Icons.Shield} label="Controle de Acessos" active={currentView === 'usuarios'} onClick={() => setCurrentView('usuarios')} />}
                            {hasAccess('settings') && <SidebarItem icon={Icons.Settings} label="Configurações (Backup)" active={currentView === 'settings'} onClick={() => setCurrentView('settings')} />}
                        </nav>

                        <div className="mt-auto pt-4 border-t border-slate-200 dark:border-slate-800 space-y-2">
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="w-full flex items-center justify-between px-4 py-3 rounded-lg transition-colors text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white">
                                <div className="flex items-center space-x-3">
                                    {isDarkMode ? <Icons.Moon size={20} /> : <Icons.Sun size={20} />}
                                    <span className="font-medium text-sm">{isDarkMode ? 'Tema Clássico' : 'Tema Claro'}</span>
                                </div>
                                <div className={`w-10 h-5 rounded-full relative transition-colors duration-300 ${isDarkMode ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                                    <div className={`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-300 shadow-sm ${isDarkMode ? 'translate-x-5' : ''}`}></div>
                                </div>
                            </button>
                            
                            <button onClick={handleLogout} className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors text-rose-600 dark:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/30">
                                <Icons.LogOut size={20} />
                                <span className="font-medium text-sm">Terminar Sessão</span>
                            </button>
                        </div>
                    </aside>

                    {/* ÁREA DE CONTEÚDO */}
                    <main className="flex-1 overflow-auto bg-slate-50 dark:bg-slate-900 p-4 md:p-8 relative transition-colors duration-200">
                        
                        {/* VIEW: DASHBOARD */}
                        {currentView === 'dashboard' && hasAccess('dashboard') && (
                            <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in duration-500 pb-20">
                                <header><h2 className="text-3xl font-bold text-slate-900 dark:text-white mb-2">Visão Geral</h2><p className="text-slate-500 dark:text-slate-400">Resumo do Ecossistema Don Gestão</p></header>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-lg flex flex-col justify-between transition-colors duration-200">
                                        <div className="flex justify-between items-start mb-4">
                                            <div><h3 className="text-slate-500 dark:text-slate-400 font-medium">Clientes na Base</h3><p className="text-4xl font-bold text-slate-900 dark:text-white mt-1">{clientes.length}</p></div>
                                            <div className="bg-emerald-100 dark:bg-emerald-500/20 p-3 rounded-lg"><Icons.Users size={24} className="text-emerald-600 dark:text-emerald-400"/></div>
                                        </div>
                                        {hasAccess('clientes') && <button onClick={()=>setCurrentView('clientes')} className="text-sm font-bold text-emerald-600 dark:text-emerald-400 hover:text-emerald-500 dark:hover:text-emerald-300 flex items-center">Gerir Clientes <Icons.ChevronRight size={16} className="ml-1"/></button>}
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-lg flex flex-col justify-between transition-colors duration-200">
                                        <div className="flex justify-between items-start mb-4">
                                            <div><h3 className="text-slate-500 dark:text-slate-400 font-medium">Extratos Arquivados</h3><p className="text-4xl font-bold text-slate-900 dark:text-white mt-1">{dbReports.length}</p></div>
                                            <div className="bg-blue-100 dark:bg-blue-500/20 p-3 rounded-lg"><Icons.FileText size={24} className="text-blue-600 dark:text-blue-400"/></div>
                                        </div>
                                        {hasAccess('gestor') && <button onClick={()=>setCurrentView('gestor-browse')} className="text-sm font-bold text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300 flex items-center">Explorar Gestor <Icons.ChevronRight size={16} className="ml-1"/></button>}
                                    </div>
                                    <div className="bg-gradient-to-br from-indigo-600 to-blue-800 p-6 rounded-xl shadow-lg text-white flex flex-col justify-center">
                                        <h3 className="font-bold mb-3 text-lg">Acesso Rápido</h3>
                                        <div className="space-y-2">
                                            {hasAccess('vendas') && <button onClick={() => setCurrentView('vendas')} className="w-full bg-white/20 hover:bg-white/30 text-white py-2 rounded-lg font-bold transition-colors text-sm flex items-center justify-center"><Icons.ShoppingCart size={16} className="mr-2"/> Painel de Vendas</button>}
                                            {hasAccess('processar') && <button onClick={() => setCurrentView('processar')} className="w-full bg-black/20 hover:bg-black/30 text-white py-2 rounded-lg font-bold transition-colors text-sm flex items-center justify-center"><Icons.Upload size={16} className="mr-2"/> Relatórios de Comissão</button>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: VENDAS DE SERVIÇOS (COM PESQUISA AVANÇADA) */}
                        {currentView === 'vendas' && hasAccess('vendas') && (
                            <div className="w-full mx-auto animate-in fade-in duration-500 pb-20">
                                <div className="flex justify-between items-center mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center"><Icons.ShoppingCart size={28} className="mr-3 text-emerald-500"/> Vendas de serviços</h2>
                                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                                            <span className="font-bold text-slate-700 dark:text-slate-300"><Icons.Home size={14} className="inline mr-1 mb-0.5"/>Início</span> &gt; Vendas de serviços &gt; Listar
                                        </p>
                                    </div>
                                </div>

                                <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 mb-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm transition-colors duration-200">
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <button onClick={() => abrirModalVenda()} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-sm font-bold flex items-center shadow-md transition-colors"><Icons.Plus size={16} className="mr-2"/> Adicionar</button>
                                        
                                        <div className="relative group">
                                            <button className="bg-slate-900 dark:bg-black hover:bg-slate-800 dark:hover:bg-slate-900 text-white px-4 py-2 rounded text-sm font-bold flex items-center transition-colors border border-slate-700 shadow-md">
                                                <Icons.Settings size={16} className="mr-2"/> Mais ações <Icons.ChevronDown size={16} className="ml-2"/>
                                            </button>
                                        </div>

                                        <button className="bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 border border-slate-300 dark:border-slate-600 px-3 py-2 rounded text-slate-600 dark:text-slate-200 transition-colors"><Icons.ListFilter size={18} /></button>
                                    </div>
                                    
                                    <div className="flex w-full md:w-auto gap-2">
                                        <div className="relative z-30">
                                            <button onClick={() => setShowVendasPeriodMenu(!showVendasPeriodMenu)} className="bg-slate-900 dark:bg-black text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center transition-colors shadow-md border border-slate-700 h-full">
                                                {displayPeriodLabel} <Icons.ChevronDown size={14} className="ml-2"/>
                                            </button>
                                            
                                            {showVendasPeriodMenu && (
                                                <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-xl rounded-lg overflow-hidden text-sm z-50 animate-in fade-in slide-in-from-top-2">
                                                    <ul className="flex flex-col py-1">
                                                        {['Hoje', 'Esta semana', 'Mês passado', 'Este mês', 'Próximo mês', 'Todo o período', 'Escolha o período'].map(preset => (
                                                            <li key={preset}>
                                                                <button onClick={() => applyDatePreset(preset)} className="w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 transition-colors font-medium">
                                                                    {preset}
                                                                </button>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            )}
                                        </div>

                                        <button onClick={() => setShowVendasFilter(!showVendasFilter)} className={`px-4 py-2 border rounded-lg text-sm font-bold flex items-center transition-colors ${showVendasFilter ? 'bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white border-slate-300 dark:border-slate-600' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>
                                            <Icons.Search size={16} className="mr-2"/> Busca avançada
                                        </button>
                                    </div>
                                </div>

                                {/* PAINEL DE BUSCA AVANÇADA */}
                                {showVendasFilter && (
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm mb-6 transition-colors duration-200 animate-in slide-in-from-top-4">
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Loja</label>
                                                <select value={vendasFilterForm.loja} onChange={e=>setVendasFilterForm({...vendasFilterForm, loja: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500">
                                                    <option value="Todos">Todos</option>
                                                    <option value="PROTETTA SEGUROS">PROTETTA SEGUROS</option>
                                                    <option value="DON GESTÃO">DON GESTÃO</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Código</label>
                                                <input type="text" value={vendasFilterForm.codigo} onChange={e=>setVendasFilterForm({...vendasFilterForm, codigo: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Data de venda</label>
                                                <div className="flex items-center gap-2">
                                                    <input type="date" value={vendasFilterForm.dataInicio} onChange={e=>setVendasFilterForm({...vendasFilterForm, dataInicio: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-2 text-xs text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                                    <span className="text-slate-400 font-medium">a</span>
                                                    <input type="date" value={vendasFilterForm.dataFim} onChange={e=>setVendasFilterForm({...vendasFilterForm, dataFim: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-2 text-xs text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Situação</label>
                                                <select value={vendasFilterForm.situacao} onChange={e=>setVendasFilterForm({...vendasFilterForm, situacao: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500">
                                                    <option value="Todos">Todos</option>
                                                    <option value="FATURADO PROTETTA NF">FATURADO PROTETTA NF</option>
                                                    <option value="PENDENTE">PENDENTE</option>
                                                    <option value="CANCELADO">CANCELADO</option>
                                                </select>
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Cliente</label>
                                                <div className="relative">
                                                    <input type="text" placeholder="Nome do cliente..." value={vendasFilterForm.cliente} onChange={e=>setVendasFilterForm({...vendasFilterForm, cliente: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500 pr-8" />
                                                    {vendasFilterForm.cliente && <Icons.Trash2 size={16} onClick={() => setVendasFilterForm({...vendasFilterForm, cliente: ''})} className="absolute right-3 top-2.5 text-slate-400 cursor-pointer hover:text-rose-500 transition-colors" />}
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Contrato do cliente</label>
                                                <input type="text" value={vendasFilterForm.contrato} onChange={e=>setVendasFilterForm({...vendasFilterForm, contrato: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Codigo operadora</label>
                                                <input type="text" value={vendasFilterForm.codigoOperadora} onChange={e=>setVendasFilterForm({...vendasFilterForm, codigoOperadora: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">N. vidas</label>
                                                <input type="number" value={vendasFilterForm.vidas} onChange={e=>setVendasFilterForm({...vendasFilterForm, vidas: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Vitalicio ou nao</label>
                                                <select value={vendasFilterForm.vitalicio} onChange={e=>setVendasFilterForm({...vendasFilterForm, vitalicio: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500">
                                                    <option value="Selecione">Selecione</option>
                                                    <option value="Sim">Sim</option>
                                                    <option value="Não">Não</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Parcela do plano</label>
                                                <input type="text" value={vendasFilterForm.parcela} onChange={e=>setVendasFilterForm({...vendasFilterForm, parcela: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Inicio vigencia (plano)</label>
                                                <input type="date" value={vendasFilterForm.inicioVigencia} onChange={e=>setVendasFilterForm({...vendasFilterForm, inicioVigencia: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Nota fiscal</label>
                                                <input type="text" value={vendasFilterForm.notaFiscal} onChange={e=>setVendasFilterForm({...vendasFilterForm, notaFiscal: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Corretor</label>
                                                <select value={vendasFilterForm.corretor} onChange={e=>setVendasFilterForm({...vendasFilterForm, corretor: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-sm text-slate-900 dark:text-white outline-none focus:border-emerald-500">
                                                    <option value="Todos">Todos</option>
                                                    <option value="Corretor Interno">Corretor Interno</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div className="flex gap-3 mt-6 border-t border-slate-200 dark:border-slate-700 pt-4">
                                            <button onClick={handleBuscarVendas} className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded text-sm font-bold flex items-center shadow transition-colors"><Icons.CheckCircle size={16} className="mr-2"/> Buscar</button>
                                            <button onClick={handleLimparVendas} className="bg-rose-500 hover:bg-rose-400 text-white px-6 py-2 rounded text-sm font-bold flex items-center shadow transition-colors"><Icons.X size={16} className="mr-2"/> Limpar</button>
                                        </div>
                                    </div>
                                )}

                                {/* TABELA DE VENDAS */}
                                <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm overflow-x-auto transition-colors duration-200">
                                    <table className="w-full text-left border-collapse text-sm whitespace-nowrap">
                                        <thead>
                                            <tr className="border-b-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-750/50 transition-colors duration-200">
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-700 w-24">Nº</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-700">Cliente</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-700 w-32">Data</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-700 text-center w-48">Situação</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-700 w-32 text-right">Valor</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 text-center w-40">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {displayedVendas.length === 0 ? (
                                                <tr><td colSpan="6" className="py-8 text-center text-slate-500 italic">Nenhum registo de venda encontrado com os filtros atuais.</td></tr>
                                            ) : (
                                                displayedVendas.map((venda, idx) => (
                                                    <tr key={venda.id} className="border-b border-slate-200 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-750/50 transition-colors">
                                                        <td className="py-4 px-4 text-slate-600 dark:text-slate-400 border-r border-slate-200 dark:border-slate-700">{venda.numero || '-'}</td>
                                                        <td className="py-4 px-4 border-r border-slate-200 dark:border-slate-700">
                                                            <div className="font-bold text-slate-900 dark:text-slate-100">{venda.cliente}</div>
                                                            <div className="text-xs text-slate-500 italic mt-0.5">({venda.loja})</div>
                                                        </td>
                                                        <td className="py-4 px-4 text-slate-600 dark:text-slate-300 border-r border-slate-200 dark:border-slate-700">{formatarDataVisivel(venda.dataVenda)}</td>
                                                        <td className="py-4 px-4 text-center border-r border-slate-200 dark:border-slate-700">
                                                            <span className={`${getSituacaoColor(venda.situacao)} px-3 py-1 rounded text-xs font-bold uppercase`}>{venda.situacao}</span>
                                                        </td>
                                                        <td className="py-4 px-4 text-slate-800 dark:text-slate-200 font-medium text-right border-r border-slate-200 dark:border-slate-700">{formatarMoeda(venda.valor)}</td>
                                                        <td className="py-4 px-4 text-center">
                                                            <div className="flex gap-1.5 justify-center">
                                                                <button className="bg-sky-500 hover:bg-sky-400 text-white p-1.5 rounded transition-colors shadow-sm" title="Visualizar Detalhes"><Icons.Search size={14}/></button>
                                                                <button onClick={() => abrirModalVenda(venda)} className="bg-amber-500 hover:bg-amber-400 text-white p-1.5 rounded transition-colors shadow-sm" title="Editar Venda"><Icons.Edit size={14}/></button>
                                                                <button onClick={() => apagarVenda(venda)} className="bg-rose-500 hover:bg-rose-400 text-white p-1.5 rounded transition-colors shadow-sm" title="Apagar Venda"><Icons.Trash2 size={14}/></button>
                                                                <button className="bg-emerald-600 hover:bg-emerald-500 text-white p-1.5 rounded transition-colors shadow-sm" title="Mais Opções"><Icons.ChevronDown size={14}/></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* VIEW: CONTROLE DE ACESSOS (USUÁRIOS) */}
                        {currentView === 'usuarios' && hasAccess('usuarios') && (
                            <div className="max-w-5xl mx-auto animate-in fade-in duration-500 pb-20">
                                <header className="mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center"><Icons.Shield className="mr-3 text-indigo-500"/> Controle de Acessos e Usuários</h2>
                                    <p className="text-slate-500 dark:text-slate-400 mt-1">Gerencie quem pode acessar o sistema e quais abas podem ver.</p>
                                </header>
                                
                                <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-md mb-6 flex justify-between items-center transition-colors">
                                    <div className="text-sm text-slate-600 dark:text-slate-400">Total de Utilizadores: <strong className="text-slate-900 dark:text-white">{usersList.length}</strong></div>
                                    <button onClick={() => abrirModalUsuario()} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded font-bold flex items-center shadow transition-colors text-sm"><Icons.Plus size={16} className="mr-2"/> Novo Utilizador</button>
                                </div>

                                <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm overflow-x-auto transition-colors duration-200">
                                    <table className="w-full text-left border-collapse text-sm whitespace-nowrap">
                                        <thead>
                                            <tr className="border-b-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-750/50 transition-colors duration-200">
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Utilizador (Login)</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Perfil de Acesso</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Acessos Permitidos</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 text-center">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {usersList.map((user) => (
                                                <tr key={user.id} className="border-b border-slate-200 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-750/50 transition-colors">
                                                    <td className="py-3 px-4 font-bold text-slate-900 dark:text-white flex items-center">
                                                        <Icons.User size={16} className="mr-2 text-slate-400" />
                                                        {user.username}
                                                    </td>
                                                    <td className="py-3 px-4">
                                                        <span className={`px-2.5 py-1 rounded-md text-xs font-bold ${user.role === 'admin' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300' : 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300'}`}>
                                                            {user.role === 'admin' ? 'Administrador' : 'Usuário Padrão'}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4 text-xs text-slate-500 dark:text-slate-400">
                                                        {user.role === 'admin' ? 'Acesso Total' : `${(user.permissions || []).length} Módulos`}
                                                    </td>
                                                    <td className="py-3 px-4 text-center">
                                                        <div className="flex gap-2 justify-center">
                                                            <button onClick={() => abrirModalUsuario(user)} className="text-amber-500 hover:text-amber-400 bg-amber-100 dark:bg-amber-400/10 p-1.5 rounded transition-colors" title="Editar Utilizador"><Icons.Edit size={16}/></button>
                                                            <button onClick={() => apagarUsuario(user)} className="text-rose-500 hover:text-rose-400 bg-rose-100 dark:bg-rose-400/10 p-1.5 rounded transition-colors" title="Apagar Utilizador"><Icons.Trash2 size={16}/></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* VIEW: RELATÓRIOS SALVOS (HISTÓRICO) */}
                        {currentView === 'historico' && hasAccess('historico') && (
                            <div className="max-w-5xl mx-auto animate-in fade-in duration-500 pb-20">
                                <header className="mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center"><Icons.Archive className="mr-3 text-indigo-500"/> Relatórios Salvos</h2>
                                    <p className="text-slate-500 dark:text-slate-400 mt-1">Consulte, edite ou imprima os relatórios gerados anteriormente.</p>
                                </header>
                                
                                <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm overflow-x-auto transition-colors duration-200">
                                    <table className="w-full text-left border-collapse text-sm whitespace-nowrap">
                                        <thead>
                                            <tr className="border-b-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-750/50 transition-colors duration-200">
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Data de Criação</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Nome do Relatório</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Período Referência</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 text-center">Registros</th>
                                                <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 text-center">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {savedReportsList.length === 0 ? (
                                                <tr><td colSpan="5" className="py-8 text-center text-slate-500 italic">Nenhum relatório foi salvo ainda. Processe e salve um na aba "Relatórios de Comissão".</td></tr>
                                            ) : (
                                                savedReportsList.slice().reverse().map((rep) => (
                                                    <tr key={rep.id} className="border-b border-slate-200 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-750/50 transition-colors">
                                                        <td className="py-3 px-4 text-slate-500 dark:text-slate-400">{new Date(rep.dataCriacao).toLocaleDateString('pt-PT')} às {new Date(rep.dataCriacao).toLocaleTimeString('pt-PT').slice(0,5)}</td>
                                                        <td className="py-3 px-4 font-bold text-slate-800 dark:text-slate-200">{rep.nome}</td>
                                                        <td className="py-3 px-4 text-slate-600 dark:text-slate-400">{rep.periodo || '-'}</td>
                                                        <td className="py-3 px-4 text-slate-600 dark:text-slate-400 text-center">{(rep.dados || []).length}</td>
                                                        <td className="py-3 px-4 text-center">
                                                            <div className="flex gap-2 justify-center">
                                                                <button onClick={() => carregarRelatorioSalvo(rep)} className="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded transition-colors text-xs font-bold">Abrir</button>
                                                                <button onClick={() => apagarRelatorioSalvo(rep.id)} className="text-rose-600 dark:text-rose-400 hover:text-rose-700 dark:hover:text-rose-300 bg-rose-50 dark:bg-rose-900/30 p-1.5 rounded transition-colors" title="Apagar Relatório"><Icons.Trash2 size={16}/></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* VIEW: CLIENTES */}
                        {currentView === 'clientes' && hasAccess('clientes') && (
                            <div className="w-full mx-auto animate-in fade-in duration-500 pb-20">
                                <div className="flex justify-between items-center mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                                    <div><h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center"><Icons.Users size={28} className="mr-3 text-emerald-500"/> Gestão de Clientes</h2><p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Lista unificada de parceiros e clientes.</p></div>
                                </div>

                                <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 mb-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm transition-colors duration-200">
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <button onClick={() => abrirModalAddEdit()} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-sm font-bold flex items-center shadow-md transition-colors"><Icons.Plus size={16} className="mr-2"/> Adicionar</button>
                                        
                                        <div className="relative group">
                                            <label className="cursor-pointer bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-4 py-2 rounded text-sm font-bold flex items-center transition-colors border border-slate-300 dark:border-slate-600">
                                                <Icons.Download size={16} className="mr-2"/> Importar
                                                <input type="file" accept=".xlsx, .csv" className="hidden" onChange={importarClientes} />
                                            </label>
                                        </div>

                                        <div className="relative z-20">
                                            <button onClick={() => setShowColMenu(!showColMenu)} className="bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 border border-slate-300 dark:border-slate-600 px-3 py-2 rounded text-slate-600 dark:text-slate-200 transition-colors"><Icons.ListFilter size={18} /></button>
                                            {showColMenu && (
                                                <div className="absolute top-full left-0 mt-2 w-56 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 shadow-xl rounded-lg overflow-hidden text-sm">
                                                    <div className="px-4 py-2 bg-slate-50 dark:bg-slate-750 font-bold border-b border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white">Colunas</div>
                                                    <div className="p-2 space-y-1">
                                                        {Object.keys(cols).map(k => (
                                                            <label key={k} className="flex items-center p-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded cursor-pointer text-slate-700 dark:text-slate-300">
                                                                <input type="checkbox" checked={cols[k]} onChange={(e) => setCols({...cols, [k]: e.target.checked})} className="mr-3 accent-emerald-500 h-4 w-4 rounded border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-700" />
                                                                {toPascalCase(k).replace('_', ' ')}
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <button onClick={() => showConfirm("Tem a certeza absoluta que deseja apagar TODOS os clientes? Esta ação é irreversível.", async () => { await supabase.from('clientes').delete().neq('id', 0); await loadFromDB(); })} className="bg-rose-100 dark:bg-rose-900/30 hover:bg-rose-200 dark:hover:bg-rose-900/50 text-rose-600 dark:text-rose-400 border border-rose-300 dark:border-rose-800/50 px-3 py-2 rounded text-sm transition-colors" title="Apagar Todos os Clientes"><Icons.Trash2 size={16}/></button>
                                    </div>
                                    
                                    <div className="flex w-full md:w-auto">
                                        <div className="relative w-full md:w-64">
                                            <Icons.Search size={16} className="absolute left-3 top-2.5 text-slate-400"/>
                                            <input type="text" value={filtroNomeCliente} onChange={(e) => setFiltroNomeCliente(e.target.value)} placeholder="Buscar cliente..." className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-200 rounded-l-lg pl-9 pr-4 py-2 text-sm focus:border-emerald-500 outline-none transition-colors duration-200" />
                                        </div>
                                        <button className="bg-slate-100 dark:bg-slate-700 px-4 py-2 border-y border-r border-slate-300 dark:border-slate-600 rounded-r-lg text-sm font-bold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 hover:text-slate-900 dark:hover:text-white transition-colors" onClick={()=>setModalBuscaOpen(true)}>Avançada</button>
                                    </div>
                                </div>

                                <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm overflow-x-auto transition-colors duration-200">
                                    <table className="w-full text-left border-collapse text-sm whitespace-nowrap">
                                        <thead>
                                            <tr className="border-b-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-750/50 transition-colors duration-200">
                                                {cols.codigo && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Código</th>}
                                                {cols.nome && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Nome</th>}
                                                {cols.tipo && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Tipo</th>}
                                                {cols.documento && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Documento</th>}
                                                {cols.telefone && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Telefone</th>}
                                                {cols.celular && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Celular</th>}
                                                {cols.email && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">E-mail</th>}
                                                {cols.situacao && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 text-center">Sit.</th>}
                                                {cols.cadastrado_em && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300">Criado em</th>}
                                                {cols.acoes && <th className="py-3 px-4 font-bold text-slate-700 dark:text-slate-300 text-center">Ações</th>}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {clientesFiltrados.length === 0 ? (
                                                <tr><td colSpan="10" className="py-8 text-center text-slate-500 italic">Nenhum cliente encontrado.</td></tr>
                                            ) : (
                                                clientesFiltrados.map((cli) => {
                                                    return (
                                                    <tr key={cli.id} className="border-b border-slate-200 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-750/50 transition-colors">
                                                        {cols.codigo && <td className="py-3 px-4 text-slate-500 dark:text-slate-400">{cli.codigo || '-'}</td>}
                                                        {cols.nome && <td className="py-3 px-4 font-medium text-slate-900 dark:text-slate-100">{cli.nome}</td>}
                                                        {cols.tipo && <td className="py-3 px-4 text-slate-600 dark:text-slate-400">{cli.tipo}</td>}
                                                        {cols.documento && <td className="py-3 px-4 text-slate-600 dark:text-slate-300">{cli.documento || '-'}</td>}
                                                        {cols.telefone && <td className="py-3 px-4 text-slate-600 dark:text-slate-300">{cli.telefone || '-'}</td>}
                                                        {cols.celular && <td className="py-3 px-4 text-slate-600 dark:text-slate-300">{cli.celular || '-'}</td>}
                                                        {cols.email && <td className="py-3 px-4 text-sky-600 dark:text-sky-400">{cli.email || '-'}</td>}
                                                        {cols.situacao && <td className="py-3 px-4 text-center">{cli.situacao ? <Icons.CheckCircle size={18} className="text-emerald-500 mx-auto"/> : <Icons.XCircle size={18} className="text-rose-500 mx-auto"/>}</td>}
                                                        {cols.cadastrado_em && <td className="py-3 px-4 text-slate-500 dark:text-slate-400">{formatarDataVisivel(cli.cadastradoEm)}</td>}
                                                        {cols.acoes && <td className="py-3 px-4">
                                                            <div className="flex gap-2 justify-center">
                                                                <button onClick={()=>abrirModalAddEdit(cli)} className="text-amber-500 dark:text-amber-400 hover:text-amber-600 dark:hover:text-amber-300 bg-amber-100 dark:bg-amber-400/10 p-1.5 rounded transition-colors" title="Editar Cliente"><Icons.Edit size={16}/></button>
                                                                <button onClick={()=>apagarCliente(cli.id)} className="text-rose-500 dark:text-rose-400 hover:text-rose-600 dark:hover:text-rose-300 bg-rose-100 dark:bg-rose-400/10 p-1.5 rounded transition-colors" title="Apagar Cliente"><Icons.Trash2 size={16}/></button>
                                                            </div>
                                                        </td>}
                                                    </tr>
                                                )})
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* VIEW: RELATÓRIOS DE COMISSÃO */}
                        {currentView === 'processar' && hasAccess('processar') && (
                            <div className="max-w-6xl mx-auto animate-in fade-in duration-500 pb-20">
                                <header className="mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center"><Icons.FileCheck size={28} className="mr-3 text-sky-500"/> Relatórios de Comissão</h2>
                                    <p className="text-slate-500 dark:text-slate-400 mt-1">Geração e edição de relatórios (Padrão Amil).</p>
                                </header>
                                
                                {successMsg && currentView === 'processar' && <div className="mb-4 bg-emerald-100 dark:bg-emerald-500/20 text-emerald-700 dark:text-emerald-300 p-3 rounded-lg text-center font-bold">{successMsg}</div>}

                                <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-md mb-6 flex flex-col md:flex-row justify-between items-center gap-4 transition-colors duration-200">
                                    <div>
                                        <h3 className="font-bold text-lg text-slate-800 dark:text-slate-100">1. Selecionar Extrato para Processamento</h3>
                                        <p className="text-sm text-slate-500 dark:text-slate-400">O sistema extrairá automaticamente os valores e clientes.</p>
                                    </div>
                                    <div className="flex flex-wrap gap-3 justify-end">
                                        <button onClick={() => setModalArquivosOpen(true)} className="bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 px-6 rounded-lg font-bold flex items-center shadow-lg transition-colors">
                                            <Icons.Database size={18} className="mr-2"/> Buscar no Sistema
                                        </button>
                                        
                                        {pdfData.length > 0 && (
                                            <React.Fragment>
                                                <button onClick={addManualRow} className="bg-amber-500 hover:bg-amber-400 text-white py-2.5 px-4 rounded-lg font-bold flex items-center shadow-lg transition-colors">
                                                    <Icons.Plus size={18} className="mr-2"/> Adicionar Linha
                                                </button>
                                                <button onClick={() => setModalPrintOpen(true)} className="bg-emerald-50 dark:bg-emerald-600/20 hover:bg-emerald-100 dark:hover:bg-emerald-600/40 text-emerald-600 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-500/50 py-2.5 px-6 rounded-lg font-bold flex items-center transition-colors">
                                                    <Icons.Printer size={18} className="mr-2"/> Imprimir Relatório
                                                </button>
                                            </React.Fragment>
                                        )}
                                    </div>
                                </div>

                                {pdfData.length > 0 && (
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-md mb-6 flex flex-col md:flex-row gap-4 items-end transition-colors duration-200 no-print">
                                        <div className="flex-1 w-full">
                                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Nome do Relatório</label>
                                            <input type="text" value={reportName} onChange={e=>setReportName(e.target.value)} placeholder="Ex: Comissões - Fev/2026" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none text-slate-900 dark:text-white transition-colors" />
                                        </div>
                                        <div className="flex-1 w-full">
                                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Período de Referência</label>
                                            <input type="text" value={reportPeriod} onChange={e=>setReportPeriod(e.target.value)} placeholder="Ex: 01/02/2026 à 28/02/2026" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none text-slate-900 dark:text-white transition-colors" />
                                        </div>
                                        <button onClick={salvarRelatorioComissao} className="bg-blue-600 hover:bg-blue-500 text-white py-2 px-6 rounded font-bold flex items-center transition-colors h-[38px] shadow">
                                            <Icons.Save size={16} className="mr-2"/> {currentReportId ? 'Atualizar Salvo' : 'Salvar Registo'}
                                        </button>
                                    </div>
                                )}

                                <div id="print-section" className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm overflow-x-auto transition-colors duration-200 w-full">
                                    <div id="print-header" className="hidden p-4 border-b border-slate-300">
                                        <div className="flex items-center gap-2 mb-2">
                                            <div className="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center font-bold text-emerald-600 border border-emerald-500">D</div>
                                            <h2 className="text-xl font-bold text-black">Relatório de comissão de vendedores</h2>
                                        </div>
                                        <p className="text-sm text-gray-600">Período: {reportPeriod || 'Não especificado'}</p>
                                        <p className="text-sm text-gray-600">Gerado em {new Date().toLocaleDateString('pt-PT')} às {new Date().toLocaleTimeString('pt-PT')}</p>
                                    </div>

                                    <table ref={tabelaPdfRef} className="w-full text-left border-collapse text-sm whitespace-nowrap">
                                        <thead>
                                            <tr className="border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-750 text-slate-600 dark:text-slate-300 transition-colors duration-200">
                                                <th className="py-3 px-4 font-bold border-r border-slate-200 dark:border-slate-700">Cód.</th>
                                                <th className="py-3 px-4 font-bold border-r border-slate-200 dark:border-slate-700">Cliente</th>
                                                <th className="py-3 px-4 font-bold border-r border-slate-200 dark:border-slate-700 text-center">Data</th>
                                                <th className="py-3 px-4 font-bold border-r border-slate-200 dark:border-slate-700 text-center">Situação</th>
                                                <th className="py-3 px-4 font-bold border-r border-slate-200 dark:border-slate-700 text-center">Loja</th>
                                                <th className="py-3 px-4 font-bold border-r border-slate-200 dark:border-slate-700 text-right text-emerald-600 dark:text-emerald-400">Valor total (Base)</th>
                                                <th className="py-3 px-4 font-bold text-right text-sky-600 dark:text-sky-400">Comissão (Líquida)</th>
                                                <th className="py-3 px-4 font-bold text-center no-print w-24">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {pdfData.length === 0 ? (
                                                <tr><td colSpan="8" className="py-8 text-center text-slate-500 italic">Nenhum dado extraído ainda. Importe o PDF.</td></tr>
                                            ) : (
                                                pdfData.map((linha, idx) => (
                                                    editRowIndex === idx ? (
                                                        <tr key={idx} className="border-b border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800 transition-colors">
                                                            <td className="py-2 px-2 border-r border-slate-200 dark:border-slate-700"><input type="text" value={editRowData.cod} onChange={e=>setEditRowData({...editRowData, cod: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-xs text-slate-900 dark:text-white outline-none focus:border-blue-500" /></td>
                                                            <td className="py-2 px-2 border-r border-slate-200 dark:border-slate-700"><input type="text" value={editRowData.cliente} onChange={e=>setEditRowData({...editRowData, cliente: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-xs text-slate-900 dark:text-white outline-none focus:border-blue-500 min-w-[150px]" /></td>
                                                            <td className="py-2 px-2 border-r border-slate-200 dark:border-slate-700"><input type="text" value={editRowData.data} onChange={e=>setEditRowData({...editRowData, data: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-xs text-slate-900 dark:text-white outline-none focus:border-blue-500 text-center" /></td>
                                                            <td className="py-2 px-2 border-r border-slate-200 dark:border-slate-700"><input type="text" value={editRowData.situacao} onChange={e=>setEditRowData({...editRowData, situacao: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-xs text-slate-900 dark:text-white outline-none focus:border-blue-500 text-center" /></td>
                                                            <td className="py-2 px-2 border-r border-slate-200 dark:border-slate-700"><input type="text" value={editRowData.loja} onChange={e=>setEditRowData({...editRowData, loja: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-xs text-slate-900 dark:text-white outline-none focus:border-blue-500 text-center" /></td>
                                                            <td className="py-2 px-2 border-r border-slate-200 dark:border-slate-700"><input type="number" step="0.01" value={editRowData.valorTotal} onChange={e=>setEditRowData({...editRowData, valorTotal: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-xs text-slate-900 dark:text-white outline-none focus:border-emerald-500 text-right" /></td>
                                                            <td className="py-2 px-2"><input type="number" step="0.01" value={editRowData.comissao} onChange={e=>setEditRowData({...editRowData, comissao: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-xs text-slate-900 dark:text-white outline-none focus:border-sky-500 text-right" /></td>
                                                            <td className="py-2 px-2 text-center no-print">
                                                                <div className="flex gap-1 justify-center">
                                                                    <button onClick={saveRowEdit} className="text-emerald-500 hover:text-emerald-400 p-1" title="Guardar Edição"><Icons.CheckCircle size={18}/></button>
                                                                    <button onClick={cancelRowEdit} className="text-rose-500 hover:text-rose-400 p-1" title="Cancelar Edição"><Icons.XCircle size={18}/></button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ) : (
                                                        <tr key={idx} className="border-b border-slate-100 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-750/30">
                                                            <td className="py-2 px-4 border-r border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400">{linha.cod}</td>
                                                            <td className="py-2 px-4 border-r border-slate-200 dark:border-slate-700 text-slate-800 dark:text-slate-200">{linha.cliente}</td>
                                                            <td className="py-2 px-4 border-r border-slate-200 dark:border-slate-700 text-center text-slate-500 dark:text-slate-400">{linha.data}</td>
                                                            <td className="py-2 px-4 border-r border-slate-200 dark:border-slate-700 text-center text-slate-500 dark:text-slate-400">{linha.situacao}</td>
                                                            <td className="py-2 px-4 border-r border-slate-200 dark:border-slate-700 text-center text-slate-500 dark:text-slate-400">{linha.loja}</td>
                                                            <td className="py-2 px-4 border-r border-slate-200 dark:border-slate-700 text-right font-medium text-slate-700 dark:text-slate-300">{formatarMoeda(linha.valorTotal)}</td>
                                                            <td className="py-2 px-4 text-right font-bold text-sky-600 dark:text-sky-400">{formatarMoeda(linha.comissao)}</td>
                                                            <td className="py-2 px-2 text-center no-print">
                                                                <div className="flex gap-2 justify-center">
                                                                    <button onClick={() => startEditingRow(idx, linha)} className="text-amber-500 hover:text-amber-400 p-1 transition-colors" title="Editar Linha"><Icons.Edit size={16}/></button>
                                                                    <button onClick={() => deleteRowFromReport(idx)} className="text-rose-500 hover:text-rose-400 p-1 transition-colors" title="Apagar Linha"><Icons.Trash2 size={16}/></button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )
                                                ))
                                            )}
                                        </tbody>
                                        {pdfData.length > 0 && (
                                            <tfoot>
                                                <tr className="bg-slate-100 dark:bg-slate-950 text-slate-900 dark:text-white border-t-2 border-slate-300 dark:border-slate-600 transition-colors duration-200">
                                                    <td colSpan="5" className="py-3 px-4 font-bold">TOTAIS APURADOS</td>
                                                    <td className="py-3 px-4 text-right font-bold text-emerald-600 dark:text-emerald-400">{formatarMoeda(pdfData.reduce((acc, l)=>acc+l.valorTotal, 0))}</td>
                                                    <td className="py-3 px-4 text-right font-bold text-sky-600 dark:text-sky-400 text-lg">{formatarMoeda(pdfData.reduce((acc, l)=>acc+l.comissao, 0))}</td>
                                                    <td className="no-print"></td>
                                                </tr>
                                            </tfoot>
                                        )}
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* VIEW: GESTOR DE EXTRATOS (ADD) */}
                        {currentView === 'gestor-add' && hasAccess('gestor') && (
                            <div className="max-w-3xl mx-auto animate-in slide-in-from-bottom-4 duration-500 pb-20">
                                <header className="mb-8 border-b border-slate-200 dark:border-slate-700 pb-4"><h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-2 flex items-center"><Icons.FolderTree className="mr-3 text-amber-500"/>Arquivar Novo Extrato</h2><p className="text-slate-500 dark:text-slate-400">Guarde ficheiros no Gestor organizados por data e parceiro.</p></header>
                                <form onSubmit={handleSubmitExtrato} className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6 shadow-xl space-y-6 transition-colors duration-200">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-2"><label className="text-sm font-medium text-slate-600 dark:text-slate-300">Ano</label><input type="number" value={formData.ano} onChange={(e) => setFormData({...formData, ano: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500" /></div>
                                        <div className="space-y-2"><label className="text-sm font-medium text-slate-600 dark:text-slate-300">Mês</label><select value={formData.mes} onChange={(e) => setFormData({...formData, mes: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500">{MESES.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                                        <div className="space-y-2"><label className="text-sm font-medium text-slate-600 dark:text-slate-300">Categoria</label><select value={formData.categoria} onChange={(e) => setFormData({...formData, categoria: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500">{CATEGORIAS.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                        <div className="space-y-2"><label className="text-sm font-medium text-slate-600 dark:text-slate-300">Empresa (Pasta)</label><select value={formData.empresa} onChange={(e) => setFormData({...formData, empresa: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-slate-900 dark:text-white outline-none focus:border-blue-500">{EMPRESAS_INTERNAS.map(e => <option key={e} value={e}>{e}</option>)}</select></div>
                                    </div>
                                    <div className="space-y-2 pt-4 border-t border-slate-200 dark:border-slate-700">
                                        <label className="text-sm font-bold text-blue-600 dark:text-blue-400">NOME DO PARCEIRO / ARQUIVO</label>
                                        <input type="text" value={formData.parceiro} onChange={(e) => setFormData({...formData, parceiro: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-3 text-slate-900 dark:text-white outline-none focus:border-blue-500" placeholder="Ex: Extrato Amil Mensal..." />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-slate-600 dark:text-slate-300">Ficheiros Anexos</label>
                                        <div onClick={() => fileInputRef.current?.click()} className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-750 hover:border-blue-500 transition-colors">
                                            <Icons.Layers size={24} className="text-slate-400 mb-2" /><p className="text-sm text-slate-500 dark:text-slate-300">Clique para anexar os extratos (PDF, Excel)</p>
                                        </div>
                                        <input type="file" ref={fileInputRef} onChange={(e)=>{ const newFiles = Array.from(e.target.files); if(newFiles.length>0){setFormData(prev=>({...prev, arquivos: [...prev.arquivos, ...newFiles]})); setFormError('');} if(fileInputRef.current) fileInputRef.current.value=""; }} className="hidden" multiple accept=".pdf,.csv,.xlsx,.xls" />
                                        {formData.arquivos.length > 0 && <div className="mt-2 space-y-2">{formData.arquivos.map((f, i) => <div key={i} className="bg-slate-50 dark:bg-slate-900 p-2 rounded border border-slate-200 dark:border-slate-700 flex justify-between items-center"><span className="text-xs text-slate-700 dark:text-slate-300 truncate">{f.name}</span><button type="button" onClick={() => setFormData(prev => ({...prev, arquivos: prev.arquivos.filter((_, idx) => idx !== i)}))} className="text-rose-500 dark:text-rose-400"><Icons.X size={14} /></button></div>)}</div>}
                                    </div>
                                    {formError && <p className="text-rose-500 dark:text-rose-400 text-sm font-medium">{formError}</p>}
                                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2 transition-colors"><Icons.Save size={20} /><span>Guardar Extrato no Banco</span></button>
                                    {successMsg && <div className="bg-emerald-100 dark:bg-emerald-500/20 text-emerald-700 dark:text-emerald-300 p-3 rounded-lg text-center font-bold">{successMsg}</div>}
                                </form>
                            </div>
                        )}

                        {/* VIEW: GESTOR DE EXTRATOS (BROWSE) */}
                        {currentView === 'gestor-browse' && hasAccess('gestor') && (
                            <div className="max-w-6xl mx-auto animate-in fade-in duration-500 pb-20">
                                <header className="mb-6 flex flex-col gap-4 border-b border-slate-200 dark:border-slate-700 pb-4">
                                    <div><h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center"><Icons.Database className="mr-3 text-indigo-500 dark:text-indigo-400"/>Gestor de Extratos</h2><p className="text-slate-500 dark:text-slate-400 mt-1">Navegação segura pelos arquivos salvos internamente.</p></div>
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><Icons.Search size={18} /></div>
                                            <input type="text" placeholder="Pesquisar extrato por nome ou parceiro..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-slate-200 rounded-lg pl-10 pr-4 py-2 outline-none focus:border-blue-500 transition-colors" />
                                            {searchTerm && <button onClick={() => setSearchTerm('')} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600 dark:hover:text-white"><Icons.X size={16} /></button>}
                                        </div>
                                        {currentPath.length > 0 && !searchTerm && <button onClick={() => setCurrentPath(currentPath.slice(0, -1))} className="bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-white px-4 rounded-lg transition-colors"><Icons.ArrowLeft size={18} /></button>}
                                    </div>
                                </header>
                                {!searchTerm && (
                                    <div className="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800 p-3 rounded-lg mb-6 border border-slate-200 dark:border-slate-700 overflow-x-auto whitespace-nowrap transition-colors">
                                        <button onClick={() => setCurrentPath([])} className="hover:text-blue-600 dark:hover:text-blue-400 flex items-center"><Icons.Home size={14} className="mr-1"/> Raiz</button>
                                        {currentPath.map((folder, index) => <React.Fragment key={index}><Icons.ChevronRight size={14} /><button onClick={() => { setCurrentPath(currentPath.slice(0, index + 1)); setSearchTerm(''); }} className="hover:text-blue-600 dark:hover:text-blue-400 font-medium">{folder}</button></React.Fragment>)}
                                    </div>
                                )}
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                    {getItemsAtCurrentPath().map((item, idx) => (
                                        <div key={idx} onClick={() => handleNavigate(item)} className={`p-4 rounded-xl border cursor-pointer flex flex-col items-center text-center space-y-3 transition-colors ${item.type === 'folder' ? 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700' : 'bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 hover:border-emerald-500/50 hover:bg-white dark:hover:bg-slate-800'}`}>
                                            <div className={`p-3 rounded-full ${item.type === 'folder' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' : 'bg-slate-100 dark:bg-slate-700 ' + getFileColorClass(item.fileName)}`}>
                                                {item.type === 'folder' ? <Icons.Folder size={32} /> : (item.fileName.endsWith('pdf') ? <Icons.FileText size={32} /> : <Icons.FileSpreadsheet size={32} />)}
                                            </div>
                                            <div className="w-full"><p className="text-sm font-medium text-slate-800 dark:text-slate-200 truncate">{item.name}</p></div>
                                        </div>
                                    ))}
                                    {getItemsAtCurrentPath().length === 0 && <div className="col-span-full py-12 text-center text-slate-500 font-medium">Pasta Vazia ou Sem Resultados.</div>}
                                </div>
                            </div>
                        )}

                        {/* VIEW: SETTINGS */}
                        {currentView === 'settings' && hasAccess('settings') && (
                            <div className="max-w-3xl mx-auto animate-in slide-in-from-right-4 duration-500 pb-20">
                                <header className="mb-8 border-b border-slate-200 dark:border-slate-700 pb-4"><h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center"><Icons.Settings className="mr-3 text-slate-500 dark:text-slate-400"/>Configurações & Backup</h2></header>
                                <div className="grid gap-6">
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors">
                                        <div className="flex items-center space-x-3 mb-4"><div className="bg-emerald-100 dark:bg-emerald-500/20 p-2 rounded-lg"><Icons.Save className="text-emerald-600 dark:text-emerald-400" /></div><div><h3 className="font-bold text-slate-900 dark:text-white text-lg">Criar Backup de Segurança</h3><p className="text-xs text-slate-500 dark:text-slate-400">Exportar Clientes e Extratos</p></div></div>
                                        <div className="grid grid-cols-1 gap-4">
                                            <button onClick={async () => {
                                                if (dbReports.length === 0 && clientes.length === 0 && savedReportsList.length === 0 && vendasList.length === 0) return showAlert("O sistema está completamente vazio.");
                                                setLoading(true); setLoadingMsg("A gerar Backup Geral...");
                                                try {
                                                    const zip = new JSZip();
                                                    zip.file("database.json", JSON.stringify(dbReports));
                                                    zip.file("clientes.json", JSON.stringify(clientes));
                                                    zip.file("historico.json", JSON.stringify(savedReportsList));
                                                    zip.file("vendas.json", JSON.stringify(vendasList));
                                                    
                                                    const allUsers = await db.users.toArray();
                                                    zip.file("usuarios.json", JSON.stringify(allUsers));
                                                    
                                                    const allFiles = await db.files.toArray();
                                                    const filesFolder = zip.folder("files");
                                                    allFiles.forEach(f => { filesFolder.file(`${f.id}_${f.fileName}`, f.blob); });
                                                    
                                                    const content = await zip.generateAsync({type: "blob"});
                                                    const url = URL.createObjectURL(content);
                                                    const a = document.createElement('a'); a.href = url; a.download = `DonGestao_Backup_${dataDeHojeInterna()}.zip`;
                                                    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                                                    showAlert("Backup transferido e guardado com sucesso!");
                                                } catch (err) { showAlert("Erro crítico: " + err); } finally { setLoading(false); }
                                            }} className="p-4 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-lg flex items-center justify-center border border-slate-300 dark:border-slate-600 hover:border-emerald-500 dark:hover:border-emerald-500 transition-colors text-slate-800 dark:text-white"><Icons.Download size={20} className="mr-2"/><span className="font-bold">Baixar Arquivo .ZIP Completo</span></button>
                                        </div>
                                    </div>
                                    <div className="bg-rose-50 dark:bg-red-900/10 p-6 rounded-xl border border-rose-200 dark:border-red-900/30 mt-4 transition-colors">
                                        <h3 className="font-bold text-rose-600 dark:text-rose-400 mb-2 flex items-center"><Icons.Trash2 size={18} className="mr-2"/> Limpeza Total</h3>
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">Isto irá apagar todos os Extratos Arquivados, Histórico e Vendas.</p>
                                        <button onClick={() => {
                                            showConfirm("PERIGO: Tem a certeza absoluta que deseja apagar TODOS os dados? Esta ação não tem volta.", async () => {
                                                await db.reports.clear(); await db.files.clear(); await db.savedReports.clear(); await db.vendas.clear(); setDbReports([]); setSavedReportsList([]); setVendasList([]); showAlert("Banco de extratos e vendas limpo com sucesso.");
                                            });
                                        }} className="w-full border border-rose-400 dark:border-rose-500/50 text-rose-600 dark:text-rose-400 hover:bg-rose-100 dark:hover:bg-rose-500/20 font-bold py-2 rounded-lg transition-colors text-sm">Apagar Todo o Banco</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* MODAIS GLOBAIS DE INTERFACE */}
                        
                        {/* Modal Add/Edit Venda */}
                        {modalVendaOpen && (
                            <div className="fixed inset-0 z-[80] flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
                                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden border border-slate-200 dark:border-slate-700 m-4 flex flex-col max-h-[90vh] transition-colors">
                                    <div className="bg-slate-50 dark:bg-slate-900 px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center transition-colors">
                                        <h2 className="text-lg font-bold text-slate-900 dark:text-white flex items-center"><Icons.ShoppingCart className="mr-2 text-emerald-500"/> {vendaForm.id ? 'Editar Venda' : 'Nova Venda'}</h2>
                                        <button onClick={() => setModalVendaOpen(false)} className="text-slate-400 hover:text-rose-500 transition-colors"><Icons.X size={20} /></button>
                                    </div>
                                    <form onSubmit={salvarVenda} className="p-6 overflow-y-auto flex-1">
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Loja *</label>
                                                <select required value={vendaForm.loja} onChange={e=>setVendaForm({...vendaForm, loja: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors">
                                                    <option>PROTETTA SEGUROS</option>
                                                    <option>DON GESTÃO</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Código</label>
                                                <input type="text" value={vendaForm.numero} onChange={e=>setVendaForm({...vendaForm, numero: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Data de venda</label>
                                                <input type="date" value={vendaForm.dataVenda} onChange={e=>setVendaForm({...vendaForm, dataVenda: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Situação *</label>
                                                <select value={vendaForm.situacao} onChange={e=>setVendaForm({...vendaForm, situacao: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors">
                                                    <option>FATURADO PROTETTA NF</option>
                                                    <option>PENDENTE</option>
                                                    <option>CANCELADO</option>
                                                </select>
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Cliente *</label>
                                                <input required type="text" value={vendaForm.cliente} onChange={e=>setVendaForm({...vendaForm, cliente: e.target.value})} placeholder="Nome do cliente" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Valor Final</label>
                                                <input type="number" step="0.01" value={vendaForm.valor} onChange={e=>setVendaForm({...vendaForm, valor: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors text-right font-bold"/>
                                            </div>

                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Contrato do cliente</label>
                                                <input type="text" value={vendaForm.contrato} onChange={e=>setVendaForm({...vendaForm, contrato: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Serviço</label>
                                                <input type="text" value={vendaForm.servico} onChange={e=>setVendaForm({...vendaForm, servico: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            
                                            <div className="md:col-span-4 mt-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Corretor Responsável</label>
                                                <select value={vendaForm.corretor} onChange={e=>setVendaForm({...vendaForm, corretor: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors">
                                                    <option>Selecione</option>
                                                    <option>Corretor Interno</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="flex justify-end gap-3 mt-6 border-t border-slate-200 dark:border-slate-700 pt-4">
                                            <button type="button" onClick={() => setModalVendaOpen(false)} className="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded text-sm font-bold transition-colors hover:bg-slate-300 dark:hover:bg-slate-600">Cancelar</button>
                                            <button type="submit" className="px-4 py-2 bg-emerald-600 text-white rounded text-sm font-bold shadow hover:bg-emerald-500 transition-colors flex items-center"><Icons.Save size={16} className="mr-2"/> Guardar Venda</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* Modal Add/Edit Usuário */}
                        {modalUserOpen && (
                            <div className="fixed inset-0 z-[80] flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
                                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 dark:border-slate-700 m-4 transition-colors">
                                    <div className="bg-slate-50 dark:bg-slate-900 px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center transition-colors">
                                        <h2 className="text-lg font-bold text-slate-900 dark:text-white flex items-center"><Icons.Shield className="mr-2 text-indigo-500"/> {userForm.id ? 'Editar Utilizador' : 'Novo Utilizador'}</h2>
                                        <button onClick={() => setModalUserOpen(false)} className="text-slate-400 hover:text-rose-500 transition-colors"><Icons.X size={20} /></button>
                                    </div>
                                    <form onSubmit={salvarUsuario} className="p-6">
                                        <div className="space-y-4 mb-6">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Nome de Utilizador (Login) *</label>
                                                <input required type="text" value={userForm.username} onChange={e=>setUserForm({...userForm, username: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none text-slate-900 dark:text-white transition-colors" disabled={userForm.username === 'admin' && userForm.id}/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Palavra-passe *</label>
                                                <div className="relative">
                                                    <input required type={showPassword ? "text" : "password"} value={userForm.password} onChange={e=>setUserForm({...userForm, password: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg pl-3 pr-10 py-2 text-sm focus:border-indigo-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors focus:outline-none" title={showPassword ? "Ocultar senha" : "Mostrar senha"}>
                                                        {showPassword ? <Icons.EyeOff size={16} /> : <Icons.Eye size={16} />}
                                                    </button>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Tipo de Perfil</label>
                                                <select value={userForm.role} onChange={e=>setUserForm({...userForm, role: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none text-slate-900 dark:text-white transition-colors" disabled={userForm.username === 'admin' && userForm.id}>
                                                    <option value="user">Usuário Padrão (Acesso Restrito)</option>
                                                    <option value="admin">Administrador (Acesso Total)</option>
                                                </select>
                                            </div>

                                            {userForm.role === 'user' && (
                                                <div className="pt-2">
                                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 border-b border-slate-200 dark:border-slate-700 pb-1">Permissões de Acesso (Módulos)</label>
                                                    <div className="space-y-2 max-h-40 overflow-y-auto pr-2">
                                                        {SYSTEM_MODULES.map(mod => (
                                                            <label key={mod.id} className="flex items-center gap-2 cursor-pointer text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-750 p-1.5 rounded transition-colors">
                                                                <input type="checkbox" checked={userForm.permissions.includes(mod.id)} onChange={(e) => {
                                                                    const newPerms = e.target.checked 
                                                                        ? [...userForm.permissions, mod.id] 
                                                                        : userForm.permissions.filter(p => p !== mod.id);
                                                                    setUserForm({...userForm, permissions: newPerms});
                                                                }} className="accent-indigo-500 w-4 h-4 rounded bg-slate-100 dark:bg-slate-800 border-slate-300 dark:border-slate-600"/>
                                                                {mod.label}
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex justify-end gap-3">
                                            <button type="button" onClick={() => setModalUserOpen(false)} className="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded-lg text-sm font-bold transition-colors hover:bg-slate-300 dark:hover:bg-slate-600">Cancelar</button>
                                            <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-lg hover:bg-indigo-500 transition-colors flex items-center"><Icons.Save size={16} className="mr-2"/> Guardar Utilizador</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* Modal Visualizar Arquivo (Gestor) */}
                        {selectedFile && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
                                <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl p-6 w-full max-w-sm relative mx-4 transition-colors">
                                    <button onClick={() => setSelectedFile(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white"><Icons.X size={20} /></button>
                                    <div className="text-center mb-6">
                                        <div className="mx-auto w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4 text-blue-500 dark:text-blue-400"><Icons.FileText size={32} /></div>
                                        <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-1 truncate px-2">{selectedFile.fileName}</h3>
                                        <p className="text-sm text-slate-500 dark:text-slate-400">Extrato Associado</p>
                                    </div>
                                    <div className="space-y-3">
                                        <button onClick={() => { const url = URL.createObjectURL(selectedFile.fileObj); window.open(url, '_blank'); setTimeout(()=>URL.revokeObjectURL(url), 1000); setSelectedFile(null); }} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold flex items-center justify-center space-x-2"><Icons.Eye size={20} /><span>Visualizar PDF/Excel</span></button>
                                        <button onClick={() => { const url = URL.createObjectURL(selectedFile.fileObj); const a = document.createElement('a'); a.href = url; a.download = selectedFile.fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(()=>URL.revokeObjectURL(url), 1000); setSelectedFile(null); }} className="w-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white py-3 rounded-lg font-bold flex items-center justify-center space-x-2 transition-colors"><Icons.Download size={20} /><span>Baixar para o PC</span></button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal Add/Edit Cliente */}
                        {modalClienteOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm">
                                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 dark:border-slate-700 m-4 transition-colors">
                                    <div className="bg-slate-50 dark:bg-slate-900 px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center transition-colors">
                                        <h2 className="text-lg font-bold text-slate-900 dark:text-white">{clienteEditIndex >= 0 ? 'Editar Cliente' : 'Adicionar Cliente'}</h2>
                                        <button onClick={() => setModalClienteOpen(false)} className="text-slate-400 hover:text-rose-500"><Icons.X size={20} /></button>
                                    </div>
                                    <form onSubmit={salvarCliente} className="p-6">
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <div className="col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Nome do Cliente *</label>
                                                <input required type="text" value={clienteForm.nome} onChange={e=>setClienteForm({...clienteForm, nome: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Tipo</label>
                                                <select value={clienteForm.tipo} onChange={e=>setClienteForm({...clienteForm, tipo: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors">
                                                    <option>Pessoa jurídica</option><option>Pessoa física</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Documento (NIF/CNPJ)</label>
                                                <input type="text" value={clienteForm.documento} onChange={e=>setClienteForm({...clienteForm, documento: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Telefone</label>
                                                <input type="text" value={clienteForm.telefone} onChange={e=>setClienteForm({...clienteForm, telefone: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Telemóvel</label>
                                                <input type="text" value={clienteForm.celular} onChange={e=>setClienteForm({...clienteForm, celular: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div className="col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">E-mail</label>
                                                <input type="email" value={clienteForm.email} onChange={e=>setClienteForm({...clienteForm, email: e.target.value})} className="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors"/>
                                            </div>
                                            <div className="col-span-2 flex items-center gap-2 mt-2">
                                                <input type="checkbox" checked={clienteForm.situacao} onChange={e=>setClienteForm({...clienteForm, situacao: e.target.checked})} className="w-4 h-4 accent-emerald-500 cursor-pointer bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded"/>
                                                <label className="text-sm font-bold text-slate-700 dark:text-slate-300">Cliente Ativo</label>
                                            </div>
                                        </div>
                                        <div className="flex justify-end gap-3">
                                            <button type="button" onClick={() => setModalClienteOpen(false)} className="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded text-sm font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Cancelar</button>
                                            <button type="submit" className="px-4 py-2 bg-emerald-600 text-white rounded text-sm font-bold hover:bg-emerald-500 shadow">Guardar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* Modal Selecionar Arquivo Interno */}
                        {modalArquivosOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm">
                                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden border border-slate-200 dark:border-slate-700 m-4 flex flex-col max-h-[80vh] transition-colors">
                                    <div className="bg-slate-50 dark:bg-slate-900 px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center shrink-0 transition-colors">
                                        <h2 className="text-lg font-bold text-slate-900 dark:text-white flex items-center"><Icons.Database className="mr-2 text-indigo-500 dark:text-indigo-400"/> Selecionar Extrato Arquivado</h2>
                                        <button onClick={() => setModalArquivosOpen(false)} className="text-slate-400 hover:text-rose-500"><Icons.X size={20} /></button>
                                    </div>
                                    <div className="p-4 overflow-y-auto">
                                        {dbReports.filter(r => (r.fileName || '').toLowerCase().endsWith('.pdf')).length === 0 ? (
                                            <p className="text-slate-500 dark:text-slate-400 text-center py-8">Nenhum Extrato PDF foi encontrado no Banco de Dados. Vá ao "Gestor de Extratos" para incluir ficheiros.</p>
                                        ) : (
                                            <div className="space-y-2">
                                                {dbReports.filter(r => (r.fileName || '').toLowerCase().endsWith('.pdf')).map(rep => (
                                                    <div key={rep.id} onClick={() => processarArquivoDoBanco(rep)} className="p-3 bg-slate-50 dark:bg-slate-750 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg cursor-pointer flex justify-between items-center transition-colors">
                                                        <div className="flex items-center space-x-3">
                                                            <div className="bg-red-100 dark:bg-red-500/20 p-2 rounded text-red-600 dark:text-red-400"><Icons.FileText size={20}/></div>
                                                            <div>
                                                                <p className="font-bold text-slate-900 dark:text-slate-200">{rep.parceiro}</p>
                                                                <p className="text-xs text-slate-500 dark:text-slate-400">{rep.empresa} • {rep.mes}/{rep.ano}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className="text-xs text-slate-500 truncate block max-w-[150px]">{rep.fileName}</span>
                                                            <span className="text-xs font-bold text-indigo-600 dark:text-indigo-400 mt-1 block hover:text-indigo-500 dark:hover:text-indigo-300">Processar Agora</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal Busca Avançada (Clientes) */}
                        {modalBuscaOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm">
                                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 dark:border-slate-700 m-4 transition-colors">
                                    <div className="bg-slate-50 dark:bg-slate-900 px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center transition-colors">
                                        <h2 className="text-lg font-bold text-slate-900 dark:text-white flex items-center"><Icons.Search className="mr-2 text-blue-500"/> Busca Avançada de Clientes</h2>
                                        <button type="button" onClick={() => setModalBuscaOpen(false)} className="text-slate-400 hover:text-rose-500"><Icons.X size={20} /></button>
                                    </div>
                                    <div className="p-6">
                                        <div className="text-center text-slate-500 dark:text-slate-400 italic">Funcionalidade da busca avançada virá aqui.</div>
                                        <div className="flex justify-end mt-4">
                                            <button onClick={() => setModalBuscaOpen(false)} className="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded text-sm font-bold">Fechar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal Configuração de Impressão */}
                        {modalPrintOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 dark:bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
                                <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl p-6 w-full max-w-sm relative mx-4 transition-colors">
                                    <button onClick={() => setModalPrintOpen(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors"><Icons.X size={20} /></button>
                                    
                                    <div className="mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                                        <h3 className="text-lg font-bold text-slate-900 dark:text-white flex items-center"><Icons.Printer className="mr-2 text-emerald-500" /> Configurar Impressão</h3>
                                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Ajuste os parâmetros para caber no papel.</p>
                                    </div>
                                    
                                    <div className="space-y-5">
                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Formato da Folha</label>
                                            <div className="flex gap-4">
                                                <label className="flex items-center gap-2 cursor-pointer text-slate-700 dark:text-slate-300">
                                                    <input type="radio" value="portrait" checked={printConfig.orientation === 'portrait'} onChange={(e) => setPrintConfig({...printConfig, orientation: e.target.value})} className="accent-emerald-500 w-4 h-4" /> Retrato
                                                </label>
                                                <label className="flex items-center gap-2 cursor-pointer text-slate-700 dark:text-slate-300">
                                                    <input type="radio" value="landscape" checked={printConfig.orientation === 'landscape'} onChange={(e) => setPrintConfig({...printConfig, orientation: e.target.value})} className="accent-emerald-500 w-4 h-4" /> Paisagem
                                                </label>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Escala de Redução (%)</label>
                                            <div className="flex items-center gap-2">
                                                <input type="number" min="30" max="200" value={printConfig.scale} onChange={(e) => setPrintConfig({...printConfig, scale: Number(e.target.value)})} className="w-24 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 outline-none text-slate-900 dark:text-white transition-colors text-center font-bold" />
                                                <span className="text-slate-500 dark:text-slate-400 font-bold">%</span>
                                            </div>
                                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-2 leading-relaxed">
                                                Dica: Se a tabela for muito larga, diminua a escala (ex: 80%) e use "Paisagem".
                                            </p>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-3 mt-8">
                                        <button onClick={() => setModalPrintOpen(false)} className="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded text-sm font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Cancelar</button>
                                        <button onClick={handlePrintConfirm} className="px-4 py-2 bg-emerald-600 text-white rounded text-sm font-bold hover:bg-emerald-500 shadow flex items-center transition-colors"><Icons.Printer size={16} className="mr-2" /> Prévia e Imprimir</button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GestorComissoesApp />);
    </script>
</body>

</html>
